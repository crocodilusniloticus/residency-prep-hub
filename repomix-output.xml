This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
forge.config.js
Gemini_Generated_Image_n7mm7n7mm7n7mm7n.png
icon.ico
index.html
js/charts.js
js/dataManager.js
js/fa.js
js/listeners.js
js/modals.js
js/state.js
js/timers.js
js/tools.js
js/uiRefs.js
js/utils.js
js/views.js
main.js
package.json
renderer.js
styles.css
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="js/fa.js">
(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :
  typeof define === 'function' && define.amd ? define(['exports'], factory) :
  (global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.fa = {}));
}(this, (function (exports) { 'use strict';

  var fp = typeof window !== "undefined" && window.flatpickr !== undefined
      ? window.flatpickr
      : { l10ns: {} };

  var Persian = {
      weekdays: {
          shorthand: ["ÛŒÚ©", "Ø¯Ùˆ", "Ø³Ù‡", "Ú†Ù‡Ø§Ø±", "Ù¾Ù†Ø¬", "Ø¬Ù…Ø¹Ù‡", "Ø´Ù†Ø¨Ù‡"],
          longhand: ["ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡", "Ø¯ÙˆØ´Ù†Ø¨Ù‡", "Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡", "Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡", "Ù¾Ù†Ú†â€ŒØ´Ù†Ø¨Ù‡", "Ø¬Ù…Ø¹Ù‡", "Ø´Ù†Ø¨Ù‡"],
      },
      // USE REAL GREGORIAN NAMES IN FARSI
      months: {
          shorthand: ["Ú˜Ø§Ù†ÙˆÛŒÙ‡", "ÙÙˆØ±ÛŒÙ‡", "Ù…Ø§Ø±Ø³", "Ø¢ÙˆØ±ÛŒÙ„", "Ù…Ù‡", "Ú˜ÙˆØ¦Ù†", "Ú˜ÙˆØ¦ÛŒÙ‡", "Ø§ÙˆØª", "Ø³Ù¾ØªØ§Ù…Ø¨Ø±", "Ø§Ú©ØªØ¨Ø±", "Ù†ÙˆØ§Ù…Ø¨Ø±", "Ø¯Ø³Ø§Ù…Ø¨Ø±"],
          longhand: ["Ú˜Ø§Ù†ÙˆÛŒÙ‡", "ÙÙˆØ±ÛŒÙ‡", "Ù…Ø§Ø±Ø³", "Ø¢ÙˆØ±ÛŒÙ„", "Ù…Ù‡", "Ú˜ÙˆØ¦Ù†", "Ú˜ÙˆØ¦ÛŒÙ‡", "Ø§ÙˆØª", "Ø³Ù¾ØªØ§Ù…Ø¨Ø±", "Ø§Ú©ØªØ¨Ø±", "Ù†ÙˆØ§Ù…Ø¨Ø±", "Ø¯Ø³Ø§Ù…Ø¨Ø±"],
      },
      firstDayOfWeek: 6, // Starts on Saturday
      ordinal: function () { return ""; },
  };

  fp.l10ns.fa = Persian;
  exports.Persian = Persian;
  exports.default = fp.l10ns;

  Object.defineProperty(exports, '__esModule', { value: true });
})));
</file>

<file path=".gitignore">
# Node.js dependencies
node_modules/

# Compiled app files
out/
</file>

<file path="forge.config.js">
const { FusesPlugin } = require('@electron-forge/plugin-fuses');
const { FuseV1Options, FuseVersion } = require('@electron/fuses');

module.exports = {
  packagerConfig: {
    asar: true,
  },
  rebuildConfig: {},
  makers: [
    {
      name: '@electron-forge/maker-squirrel',
      config: {},
    },
    {
      name: '@electron-forge/maker-zip',
      platforms: ['darwin'],
    },
    {
      name: '@electron-forge/maker-deb',
      config: {},
    },
    {
      name: '@electron-forge/maker-rpm',
      config: {},
    },
  ],
  plugins: [
    {
      name: '@electron-forge/plugin-auto-unpack-natives',
      config: {},
    },
    // Fuses are used to enable/disable various Electron functionality
    // at package time, before code signing the application
    new FusesPlugin({
      version: FuseVersion.V1,
      [FuseV1Options.RunAsNode]: false,
      [FuseV1Options.EnableCookieEncryption]: true,
      [FuseV1Options.EnableNodeOptionsEnvironmentVariable]: false,
      [FuseV1Options.EnableNodeCliInspectArguments]: false,
      [FuseV1Options.EnableEmbeddedAsarIntegrityValidation]: true,
      [FuseV1Options.OnlyLoadAppFromAsar]: true,
    }),
  ],
};
</file>

<file path="js/charts.js">
let state, refs;
// IMPORT UTILS
const { getLocalISODateString, getPersianDateString } = require('./utils');

function init(appState, uiRefs) {
    state = appState;
    refs = uiRefs;
}

function getCharts() {
    return {
        timeChart: state.timeChart,
        scoreChart: state.scoreChart,
        zoomedTimeChart: state.zoomedTimeChart,
        zoomedScoreChart: state.zoomedScoreChart
    };
}

function initializeCharts() {
    const chartOptions = { 
        renderer: 'svg', 
        devicePixelRatio: window.devicePixelRatio || 2 
    };
    
    state.timeChart = echarts.init(refs.timeChart, null, chartOptions);
    state.scoreChart = echarts.init(refs.scoreChart, null, chartOptions);

    const chartResizeObserver = new ResizeObserver(() => {
        if (state.timeChart) state.timeChart.resize();
        if (state.scoreChart) state.scoreChart.resize();
    });

    chartResizeObserver.observe(refs.timeChart);
    chartResizeObserver.observe(refs.scoreChart);

    const toggleZoom = (isVisible) => {
        state.scoreChart.setOption({ dataZoom: [{ show: isVisible }] });
    };
    refs.scoreChart.addEventListener('mouseenter', () => toggleZoom(true));
    refs.scoreChart.addEventListener('mouseleave', () => toggleZoom(false));
}

function updateLeftChartHeader(title, showStats = false, statData = null) {
    const titleEl = document.getElementById('chart-title-left');
    if (titleEl) titleEl.textContent = title;

    const statsContainer = document.getElementById('trend-stats-container');
    const valueEl = document.getElementById('trend-stats-value');
    const statusEl = document.getElementById('trend-stats-status');

    if (showStats && statData) {
        if (valueEl) valueEl.textContent = `${statData.label}: ${statData.value}h/d`;
        if (statusEl) {
            statusEl.textContent = `${statData.icon} ${statData.text}`;
            statusEl.style.color = statData.color;
        }
        statsContainer.classList.add('visible');
    } else {
        statsContainer.classList.remove('visible');
    }
}

function getTrendChartOptions() {
    const days = state.trendChartSpan || 7;
    const isHighDensity = days > 14; 
    const labelFontSize = isHighDensity ? 9 : 11;       
    const labelPadding = isHighDensity ? [2, 4] : [4, 8]; 
    const labelDistance = isHighDensity ? 5 : 8;       

    const now = new Date();
    let totalSec7 = 0; let totalSec30 = 0;

    state.allSessions.forEach(s => {
        const sTime = new Date(s.timestamp).getTime();
        const diffTime = now.getTime() - sTime;
        const diffDays = diffTime / (1000 * 3600 * 24);
        if (diffDays <= 7) totalSec7 += s.seconds;
        if (diffDays <= 30) totalSec30 += s.seconds;
    });

    const avgDaily7 = (totalSec7 / 7 / 3600);
    const avgDaily30 = (totalSec30 / 30 / 3600);
    
    const statLabel = isHighDensity ? "Month" : "Week";
    const statValue = isHighDensity ? avgDaily30.toFixed(1) : avgDaily7.toFixed(1);

    let statusText = "Gathering Data...";
    let statusColor = "#4a413a"; 
    let statusIcon = "â—‹";

    if (avgDaily7 < 1 ) { statusText = "Focus up!"; statusIcon = "âš¡"; statusColor = "#cd5c5c"; } 
    else {
        const ratio = avgDaily30 > 0 ? (avgDaily7 / avgDaily30) : 2.0;
        if (ratio >= 1.5) { statusText = "On Fire!"; statusColor = "#c68e17"; statusIcon = "ğŸ”¥"; } 
        else if (ratio >= 0.9) { statusText = "Consistent"; statusColor = "#66bb6a"; statusIcon = "âœ…"; } 
        else if (ratio >= 0.5) { statusText = "Keep Pushing"; statusColor = "#546e7a"; statusIcon = "ğŸ“ˆ"; } 
        else { statusText = "Focus up!"; statusColor = "#cd5c5c"; statusIcon = "âš ï¸"; }
    }

    updateLeftChartHeader(`Study Trend (Last ${days} Days)`, true, {
        label: statLabel, value: statValue, text: statusText, color: statusColor, icon: statusIcon
    });

    const getPerformanceStyle = (hours) => {
        if (!hours || hours < 0.2) return { bg: '#e0e0e0', text: '#4a413a' }; 
        const ratio = hours / 2; 
        if (ratio < 0.5) return { bg: '#78909c', text: '#fffaf0' }; 
        if (ratio < 1.0) return { bg: '#66bb6a', text: '#fffaf0' }; 
        if (ratio < 1.5) return { bg: '#c68e17', text: '#2c2c2c' }; 
        return { bg: '#8b3a3a', text: '#fffaf0' }; 
    };

    const endDate = new Date();
    const dates = [];
    for (let i = days - 1; i >= 0; i--) {
        const d = new Date();
        d.setDate(endDate.getDate() - i);
        dates.push(getLocalISODateString(d));
    }

    const dataMap = {};
    dates.forEach(date => dataMap[date] = {});
    state.allSessions.forEach(s => {
        const sDate = getLocalISODateString(new Date(s.timestamp));
        if (dataMap[sDate]) dataMap[sDate][s.course] = (dataMap[sDate][s.course] || 0) + s.seconds;
    });

    const activeCourses = state.allCourses.filter(course => dates.some(date => (dataMap[date][course] || 0) > 0));

    const styledTotalData = dates.map(date => {
        let sum = 0;
        Object.values(dataMap[date]).forEach(seconds => sum += seconds);
        if (sum === 0) return null; 
        const hours = parseFloat((sum / 3600).toFixed(2));
        const style = getPerformanceStyle(hours); 
        return { 
            value: hours, 
            label: { backgroundColor: style.bg, color: style.text, borderRadius: 12, padding: labelPadding } 
        };
    });

    const palette = ['#546e7a', '#c68e17', '#8b3a3a', '#9e9e9e', '#66bb6a', '#795548', '#cd5c5c'];

    const series = activeCourses.map((course, index) => {
        const data = dates.map(date => ((dataMap[date][course] || 0) / 3600).toFixed(2));
        return {
            name: course, type: 'bar', stack: 'total', data: data,
            itemStyle: { color: palette[index % palette.length] },
            emphasis: { focus: 'series' }
        };
    });

    series.push({
        name: 'Total Daily', type: 'line', symbol: 'circle', symbolSize: 1, data: styledTotalData, 
        lineStyle: { width: 0, opacity: 0 }, itemStyle: { color: 'transparent', borderWidth: 0 }, silent: true, 
        label: {
            show: true, position: 'top', distance: labelDistance, 
            formatter: (params) => parseFloat(params.value) > 0 ? `${parseFloat(params.value).toFixed(1)}h` : '',
            fontWeight: 'bold', fontSize: labelFontSize
        }, z: 10 
    });

    return {
        tooltip: { 
            trigger: 'axis', axisPointer: { type: 'shadow' },
            backgroundColor: 'rgba(255, 255, 255, 0.95)', borderColor: '#e0e0e0',
            textStyle: { color: '#4a413a', fontWeight: '600' },
            formatter: function (params) {
                // --- PERSIAN HEADER IN TOOLTIP ---
                // params[0].name is the X-Axis label (Gregorian ISO). Convert to Persian.
                const pDate = getPersianDateString(new Date(params[0].name));
                let tooltipHtml = `<div style="margin-bottom:4px; border-bottom:1px solid #e0e0e0; padding-bottom:4px;">${pDate}</div>`;
                // ---------------------------------
                let hasData = false;
                params.forEach(item => {
                    if (item.seriesName !== 'Total Daily' && parseFloat(item.value) > 0) {
                        hasData = true;
                        const colorDot = `<span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;background-color:${item.color};"></span>`;
                        tooltipHtml += `<div style="display:flex; justify-content:space-between; gap:15px; margin-top:4px;"><span>${colorDot} ${item.seriesName}</span><span style="font-weight:bold">${item.value}h</span></div>`;
                    }
                });
                if (!hasData) return `${pDate}<br/>No study data`;
                return tooltipHtml;
            }
        },
        legend: { type: 'scroll', bottom: 0, textStyle: { color: '#4a413a' }, data: activeCourses },
        grid: { left: '2%', right: '3%', bottom: '12%', top: '10%', containLabel: true },
        xAxis: { 
            type: 'category', 
            data: dates, 
            axisLine: { lineStyle: { color: '#e0e0e0' } }, 
            axisLabel: { 
                color: '#4a413a',
                // --- PERSIAN LABELS ON X-AXIS ---
                formatter: function(value) {
                    return getPersianDateString(new Date(value));
                }
                // --------------------------------
            } 
        },
        yAxis: { type: 'value', splitLine: { lineStyle: { color: '#e0e0e0', type: 'dashed' } }, axisLabel: { color: '#4a413a' } },
        series: series
    };
}

function getTimeChartOptions(modeOverride) {
    const mode = modeOverride || state.pieChartMode || 'total';
    if (mode === 'trend') return getTrendChartOptions();

    let sessionsToDisplay = state.allSessions;
    let title = 'Study Time (Total)';
    if (mode === 'today') {
        const todayStr = getLocalISODateString(new Date());
        sessionsToDisplay = state.allSessions.filter(s => getLocalISODateString(new Date(s.timestamp)) === todayStr);
        title = 'Study Time (Today)';
    }

    updateLeftChartHeader(title, false);
    const courseData = {};
    let totalSeconds = 0;
    sessionsToDisplay.forEach(s => { 
        courseData[s.course] = (courseData[s.course] || 0) + (s.seconds || 0);
        totalSeconds += (s.seconds || 0);
    });

    const chartData = Object.keys(courseData).map(course => ({ name: course, value: (courseData[course] / 3600) }));
    
    const piePalette = ['#8b3a3a', '#c68e17', '#546e7a', '#66bb6a', '#cd5c5c', '#8d6e63'];

    return {
        color: piePalette,
        tooltip: { 
            trigger: 'item', 
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            borderColor: '#e0e0e0',
            textStyle: { color: '#4a413a' },
            formatter: (p) => {
                const colorDot = `<span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;background-color:${p.color};"></span>`;
                return `${colorDot} <b>${p.name}</b><br/>${parseFloat(p.value).toFixed(2)}h (${p.percent}%)`;
            }
        },
        legend: { 
            type: 'scroll', 
            orient: 'vertical',
            right: 0,
            top: 'middle',
            height: '90%',
            textStyle: { color: '#4a413a', fontWeight: 'bold' },
            pageIconColor: '#8b3a3a',
            pageTextStyle: { color: '#4a413a' }
        },
        series: [{ 
            type: 'pie', 
            radius: ['60%', '90%'], 
            center: ['42%', '50%'], 
            data: chartData, 
            label: { show: false },
            itemStyle: { borderColor: '#fffaf0', borderWidth: 3 },
            emphasis: { scale: true, scaleSize: 5 }
        }]
    };
}

function updateTimeChart() {
    state.timeChart.clear(); 
    const option = getTimeChartOptions(state.pieChartMode);
    state.timeChart.setOption(option, { notMerge: true });

    const overlay = document.getElementById('pie-overlay');
    const valEl = document.getElementById('pie-val');

    if (overlay && valEl) {
        if (state.pieChartMode === 'trend') {
            overlay.classList.add('hidden');
        } else {
            overlay.classList.remove('hidden');
            let totalSeconds = 0;
            let sessions = state.allSessions;
            if (state.pieChartMode === 'today') {
                const todayStr = getLocalISODateString(new Date());
                sessions = sessions.filter(s => getLocalISODateString(new Date(s.timestamp)) === todayStr);
            }
            sessions.forEach(s => totalSeconds += (s.seconds || 0));
            valEl.textContent = (totalSeconds / 3600).toFixed(1);
        }
    }
}

function getScoreChartOptions() {
    const scoresByCourse = {};
    state.allScores.forEach(s => { 
        if (!scoresByCourse[s.course]) scoresByCourse[s.course] = []; 
        scoresByCourse[s.course].push([new Date(s.timestamp), s.score]); 
    });
    
    const series = Object.keys(scoresByCourse).map(course => ({
        name: course, type: 'line', data: scoresByCourse[course].sort((a, b) => a[0] - b[0]),
        smooth: true, symbol: 'circle', symbolSize: 6, lineStyle: { width: 3 }
    }));
    
    const scorePalette = ['#cd5c5c', '#546e7a', '#8b3a3a', '#66bb6a', '#c68e17'];

    return {
        color: scorePalette,
        tooltip: { 
            trigger: 'axis',
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            borderColor: '#e0e0e0',
            textStyle: { color: '#4a413a' },
            // --- PERSIAN TOOLTIP FOR SCORE CHART ---
            formatter: function(params) {
                // params[0].axisValue is the time. 
                const date = new Date(params[0].axisValue);
                const pDate = getPersianDateString(date);
                let html = `<div style="margin-bottom:4px; border-bottom:1px solid #e0e0e0; padding-bottom:4px;">${pDate}</div>`;
                params.forEach(item => {
                    const colorDot = `<span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;background-color:${item.color};"></span>`;
                    html += `<div style="display:flex; justify-content:space-between; gap:15px; margin-top:4px;"><span>${colorDot} ${item.seriesName}</span><span style="font-weight:bold">${item.value[1]}%</span></div>`;
                });
                return html;
            }
            // ---------------------------------------
        },
        legend: { type: 'scroll', bottom: '0', textStyle: { color: '#4a413a' } },
        grid: { left: '10%', right: '10%', top: '10%', bottom: '28%' },
        xAxis: { 
            type: 'time', 
            axisLabel: { 
                color: '#4a413a',
                // --- PERSIAN AXIS LABELS ---
                formatter: function(value) {
                    return getPersianDateString(new Date(value));
                }
                // ---------------------------
            }, 
            splitLine: { show: false } 
        },
        yAxis: { type: 'value', min: 0, max: 100, axisLabel: { color: '#4a413a' }, splitLine: { lineStyle: { color: '#e0e0e0', type: 'dashed' } } },
        
        dataZoom: [{ 
            type: 'slider',
            show: false, 
            start: 0, 
            end: 100, 
            height: 5,        
            bottom: '12%',
            showDataShadow: false, 
            moveHandleSize: 0,     
            borderColor: 'transparent', 
            backgroundColor: '#e0e0e0',  
            fillerColor: '#8b3a3a',      
            borderRadius: 4,             
            handleIcon: 'path://M512 512m-208 0a208 208 0 1 0 416 0 208 208 0 1 0-416 0Z', 
            handleSize: '200%', 
            handleStyle: {
                color: '#fffaf0',      
                borderColor: '#8b3a3a', 
                borderWidth: 2,
                shadowBlur: 3,
                shadowColor: 'rgba(0, 0, 0, 0.2)'
            },
            textStyle: { color: '#4a413a' } 
        }],
        series: series
    };
}

function updateScoreChart() {
    const option = getScoreChartOptions();
    state.scoreChart.setOption(option, { notMerge: true });
}

function setPieMode(mode) {
    state.pieChartMode = mode;
    refs.btnPieTotal.classList.toggle('active', mode === 'total');
    refs.btnPieToday.classList.toggle('active', mode === 'today');
    refs.btnPieTrend.classList.toggle('active', mode === 'trend');
    if (mode === 'trend') refs.trendSpanSelect.classList.remove('hidden'); else refs.trendSpanSelect.classList.add('hidden');
    updateTimeChart(); 
}

module.exports = {
    init, initializeCharts, getTimeChartOptions, getTrendChartOptions, getScoreChartOptions,
    updateTimeChart, updateScoreChart, setPieMode, getCharts
};
</file>

<file path="js/dataManager.js">
const { getLocalISODateString } = require('./utils');
let state, refs;

function init(appState, uiRefs) {
    state = appState;
    refs = uiRefs;
}

function saveLastSelectedCourse() {
    if (state.lastSelectedCourse) {
        localStorage.setItem('lastSelectedCourse', state.lastSelectedCourse);
    }
}

function saveTimerProgress() {
    let activeTimerData = null;

    if (state.isStopwatchRunning || state.isStopwatchPaused) {
        activeTimerData = {
            type: 'stopwatch',
            startTime: state.stopwatchStartTime,
            isPaused: state.isStopwatchPaused,
            pausedSeconds: state.stopwatchSeconds, 
            context: {
                course: refs.courseSelect.value,
                notes: refs.sessionNotes.value.trim()
            }
        };
    } else if (state.pomodoroState !== 'idle') {
        activeTimerData = {
            type: 'pomodoro',
            startTime: state.pomodoroStartTime, 
            originalDuration: state.pomodoroOriginalDuration,
            isPaused: state.isPomodoroPaused,
            pausedRemainingSeconds: state.isPomodoroPaused ? state.pomodoroPausedTime : state.pomodoroSecondsLeft,
            pomodoroState: state.pomodoroState,
            context: {
                course: refs.pomodoroCourseSelect.value,
                notes: refs.pomodoroNotes.value.trim()
            }
        };
    } else if (state.isCountdownRunning || state.isCountdownPaused) {
        activeTimerData = {
            type: 'countdown',
            startTime: state.countdownStartTime,
            originalDuration: state.countdownOriginalDuration,
            isPaused: state.isCountdownPaused,
            pausedRemainingSeconds: state.isCountdownPaused ? state.countdownPausedTime : state.countdownSecondsLeft,
            context: {
                course: refs.countdownCourseSelect.value,
                notes: refs.countdownNotes.value.trim()
            }
        };
    }

    if (activeTimerData) {
        localStorage.setItem('activeTimer', JSON.stringify(activeTimerData));
    } else {
        localStorage.removeItem('activeTimer');
    }
}

function saveData() { 
    localStorage.setItem('studySessions', JSON.stringify(state.allSessions)); 
    localStorage.setItem('studyScores', JSON.stringify(state.allScores)); 
    localStorage.setItem('studyEvents', JSON.stringify(state.allEvents));
    localStorage.setItem('studyCourses', JSON.stringify(state.allCourses));
    localStorage.setItem('streakTarget', state.streakTarget); 
    localStorage.setItem('streakMinMinutes', state.streakMinMinutes);
    
    // *** NEW: Save Pomodoro Settings ***
    const pomodoroSettings = {
        focus: state.pomodoroFocusDuration,
        shortBreak: state.pomodoroShortBreakDuration,
        longBreak: state.pomodoroLongBreakDuration
    };
    localStorage.setItem('pomodoroSettings', JSON.stringify(pomodoroSettings));
    
    saveTimerProgress();
    calculateStreak(); 
}

function loadData() { 
    state.allSessions = (JSON.parse(localStorage.getItem('studySessions')) || [])
        .filter(s => s && s.timestamp && s.course); 
    state.allScores = (JSON.parse(localStorage.getItem('studyScores')) || [])
        .filter(s => s && s.timestamp && s.course); 
    state.allEvents = (JSON.parse(localStorage.getItem('studyEvents')) || [])
        .map(e => ({...e, isDone: typeof e.isDone === 'boolean' ? e.isDone : false}))
        .filter(e => e && e.date && e.title && e.timestamp);
    
    const savedCourses = JSON.parse(localStorage.getItem('studyCourses'));
    if (savedCourses && savedCourses.length > 0) {
        state.allCourses = savedCourses;
    } else {
        state.allCourses = ["Cardio", "Pulmono", "Nephro", "Gastro", "Endocrino", "Hemato", "Neuro", "Infect", "Rheumatology", "Surgery", "Peds", "Psychiatry", "Dermatology", "Gyneco", "Radio", "Ortho", "Uro", "Ophtalmo", "Biostat", "Pharma", "ENT", "Akhlagh", "Patho", "Genetics", "Physics", "Immuno", "Nutrition"];
    }
    state.allCourses.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
    
    state.lastSelectedCourse = localStorage.getItem('lastSelectedCourse');
    state.streakTarget = parseInt(localStorage.getItem('streakTarget')) || 7;
    state.streakMinMinutes = parseInt(localStorage.getItem('streakMinMinutes')) || 15;

    // *** NEW: Load Pomodoro Settings ***
    const savedPomo = JSON.parse(localStorage.getItem('pomodoroSettings'));
    if (savedPomo) {
        state.pomodoroFocusDuration = savedPomo.focus || 50;
        state.pomodoroShortBreakDuration = savedPomo.shortBreak || 10;
        state.pomodoroLongBreakDuration = savedPomo.longBreak || 20;
    }

    const savedAlarm = localStorage.getItem('alarmSound') || '';
    if (savedAlarm) {
        refs.alarmSound.src = 'file://' + savedAlarm;
        refs.selectedAlarmFile.textContent = savedAlarm.split('\\').pop().split('/').pop();
    }

    const savedCountdown = JSON.parse(localStorage.getItem('countdownValues'));
    if (savedCountdown) {
        refs.countdownHours.value = savedCountdown.h ?? 0;
        refs.countdownMinutes.value = savedCountdown.m ?? 30;
        refs.countdownSeconds.value = savedCountdown.s ?? 0;
    }

    calculateStreak();
}

function calculateStreak() {
    if (!state.allSessions || state.allSessions.length === 0) {
        state.streakCount = 0;
        return;
    }

    const dailyTotals = {};
    state.allSessions.forEach(s => {
        const dateStr = getLocalISODateString(new Date(s.timestamp));
        dailyTotals[dateStr] = (dailyTotals[dateStr] || 0) + (s.seconds || 0);
    });

    const minSeconds = (state.streakMinMinutes || 0) * 60;
    const validDates = Object.keys(dailyTotals).filter(date => dailyTotals[date] >= minSeconds);
    const sortedDates = validDates.sort((a, b) => new Date(b) - new Date(a)); 

    if (sortedDates.length === 0) {
        state.streakCount = 0;
        return;
    }

    const today = getLocalISODateString(new Date());
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = getLocalISODateString(yesterday);

    if (sortedDates[0] !== today && sortedDates[0] !== yesterdayStr) {
        state.streakCount = 0;
        return;
    }

    let streak = 0;
    let checkDate = new Date(); 
    if (sortedDates[0] === yesterdayStr) {
        checkDate = new Date(yesterday);
    }
    
    while (true) {
        const dateStr = getLocalISODateString(checkDate);
        if (dailyTotals[dateStr] >= minSeconds) { 
            streak++;
            checkDate.setDate(checkDate.getDate() - 1);
        } else {
            break;
        }
    }
    state.streakCount = streak;
}

function exportData() {
    const data = {
        sessions: state.allSessions,
        scores: state.allScores,
        events: state.allEvents,
        courses: state.allCourses,
        preferences: {
            streakTarget: state.streakTarget,
            streakMinMinutes: state.streakMinMinutes,
            lastCourse: state.lastSelectedCourse,
            countdown: JSON.parse(localStorage.getItem('countdownValues')),
            alarmSound: localStorage.getItem('alarmSound'),
            // *** NEW: Export Pomodoro Settings ***
            pomodoroSettings: {
                focus: state.pomodoroFocusDuration,
                shortBreak: state.pomodoroShortBreakDuration,
                longBreak: state.pomodoroLongBreakDuration
            }
        }
    };

    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `residency_backup_${getLocalISODateString(new Date())}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importData(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            
            if (!Array.isArray(data.sessions) || !Array.isArray(data.courses)) {
                throw new Error("Invalid data format");
            }

            state.allSessions = data.sessions;
            state.allScores = data.scores || [];
            state.allEvents = data.events || [];
            state.allCourses = data.courses;
            
            if (data.preferences) {
                state.streakTarget = data.preferences.streakTarget || 7;
                state.streakMinMinutes = data.preferences.streakMinMinutes || 15;
                state.lastSelectedCourse = data.preferences.lastCourse;
                if (data.preferences.alarmSound) localStorage.setItem('alarmSound', data.preferences.alarmSound);
                if (data.preferences.countdown) localStorage.setItem('countdownValues', JSON.stringify(data.preferences.countdown));
                
                // *** NEW: Import Pomodoro Settings ***
                if (data.preferences.pomodoroSettings) {
                    state.pomodoroFocusDuration = data.preferences.pomodoroSettings.focus || 50;
                    state.pomodoroShortBreakDuration = data.preferences.pomodoroSettings.shortBreak || 10;
                    state.pomodoroLongBreakDuration = data.preferences.pomodoroSettings.longBreak || 20;
                }
            }

            saveData();
            alert("Data imported successfully! The app will now reload.");
            window.location.reload();

        } catch (err) {
            console.error(err);
            alert("Error importing data. File might be corrupted or invalid.");
        }
    };
    reader.readAsText(file);
}

function checkForRecoveredSession() {
    const recoveredTimer = JSON.parse(localStorage.getItem('activeTimer'));
    if (!recoveredTimer || !recoveredTimer.startTime) {
        localStorage.removeItem('activeTimer');
        return;
    }

    let elapsedSeconds = 0;
    let course = '', notes = '', timestamp = '';
    
    try {
        course = recoveredTimer.context.course;
        notes = recoveredTimer.context.notes;
        timestamp = new Date(recoveredTimer.startTime).toISOString();

        if (recoveredTimer.type === 'stopwatch') {
            elapsedSeconds = recoveredTimer.pausedSeconds;
        } else if (recoveredTimer.type === 'pomodoro') {
            if (recoveredTimer.pomodoroState !== 'studying') {
                localStorage.removeItem('activeTimer');
                return;
            }
            elapsedSeconds = recoveredTimer.originalDuration - recoveredTimer.pausedRemainingSeconds;
        } else if (recoveredTimer.type === 'countdown') {
            elapsedSeconds = recoveredTimer.originalDuration - recoveredTimer.pausedRemainingSeconds;
        }

        if (elapsedSeconds >= 1) { 
            state.allSessions.push({ 
                type:'session',
                course: course,
                duration: formatTime(elapsedSeconds),
                seconds: elapsedSeconds,
                notes: `${notes || ''}`.trim(), 
                timestamp: timestamp
            });
            localStorage.setItem('studySessions', JSON.stringify(state.allSessions)); 
        }

    } catch (err) {
        console.error("Error recovering session:", err, recoveredTimer);
    }
    localStorage.removeItem('activeTimer'); 
}

function deleteItem(timestamp) { 
    state.allSessions = state.allSessions.filter(i => i.timestamp !== timestamp); 
    state.allScores = state.allScores.filter(i => i.timestamp !== timestamp); 
    state.allEvents = state.allEvents.filter(i => i.timestamp !== timestamp); 
    saveData(); 
}

function logSession(course, seconds, notes, startTimeStamp) { 
    state.allSessions.push({ 
        type:'session',
        course: course,
        duration: formatTime(seconds),
        seconds: seconds,
        notes: notes.trim(),
        timestamp: startTimeStamp || new Date().toISOString()
    }); 
    saveData(); 
    refs.sessionNotes.value = ''; 
}

function logScore() { 
    const s = parseInt(refs.scoreInput.value, 10); 
    if(isNaN(s) || s < 0 || s > 100){
        refs.scoreError.textContent = 'Score must be a number from 0-100.';
        return false;
    }
    refs.scoreError.textContent = ''; 
    state.allScores.push({type:'score',course: refs.scoreCourseSelect.value,score:s,notes: refs.scoreNotes.value.trim(),timestamp:new Date().toISOString()}); 
    saveData(); 
    refs.scoreInput.value='';
    refs.scoreNotes.value='';
    return true;
}

function formatTime(sec) { 
    const h=Math.floor(sec/3600).toString().padStart(2,'0'); 
    const m=Math.floor((sec%3600)/60).toString().padStart(2,'0'); 
    const s=(sec%60).toString().padStart(2,'0'); 
    return `${h}:${m}:${s}`; 
}

module.exports = {
    init, 
    saveData, 
    saveTimerProgress, 
    loadData, 
    checkForRecoveredSession, 
    deleteItem, 
    logSession, 
    logScore, 
    formatTime,
    saveLastSelectedCourse,
    exportData,
    importData
};
</file>

<file path="js/modals.js">
const { exec } = require('child_process'); 
const { getLocalISODateString } = require('./utils');

let state, refs, dataManager, updateAllDisplays;
// Added getTrendChartOptions to this list
let getTimeChartOptions, getScoreChartOptions, getCharts, getTrendChartOptions; 
let editDatePickerInstance = null; 

// --- UPDATED INIT: Accepts trendChartFn ---
function init(appState, uiRefs, dataMgr, updateFn, timeChartFn, scoreChartFn, getChartsFn, trendChartFn) {
    state = appState;
    refs = uiRefs;
    dataManager = dataMgr;
    updateAllDisplays = updateFn;
    
    getTimeChartOptions = timeChartFn;
    getScoreChartOptions = scoreChartFn;
    getCharts = getChartsFn;
    getTrendChartOptions = trendChartFn; // Store the function
}

function showEventModal(date, timestamp = null) { 
    refs.eventError.textContent = ''; 
    
    if (timestamp) {
        const event = state.allEvents.find(e => e.timestamp === timestamp);
        if (!event) return;
        refs.modalTitle.textContent = 'Edit Deadline';
        refs.eventText.value = event.title;
        refs.eventTimestamp.value = event.timestamp;
        state.eventModalPicker.setDate(event.date);
    } else {
        refs.modalTitle.textContent = `Add Deadline`; 
        refs.eventText.value = ''; 
        refs.eventTimestamp.value = '';
        state.eventModalPicker.setDate(date || new Date());
    }
    refs.eventModal.style.display = 'flex'; 
    refs.eventText.focus(); 
}

function hideEventModal() { refs.eventModal.style.display = 'none'; }

function saveEvent() {
    const title = refs.eventText.value.trim();
    const date = refs.eventDatePicker.value; 
    const ts = refs.eventTimestamp.value;

    if (!title) { refs.eventError.textContent = 'Event title cannot be empty.'; return; }
    if (!date) { refs.eventError.textContent = 'Please select a due date.'; return; }

    if (ts) {
        const eventIndex = state.allEvents.findIndex(e => e.timestamp === ts);
        if (eventIndex > -1) {
            state.allEvents[eventIndex].title = title;
            state.allEvents[eventIndex].date = date;
        }
    } else {
        state.allEvents.push({ 
            type: 'event', 
            title: title, 
            date: date, 
            timestamp: new Date().toISOString(), 
            isDone: false 
        });
    }
    
    dataManager.saveData();
    state.isSavingEvent = true;
    hideEventModal();
    if (state.calendar) state.calendar.setDate([], false);
    updateAllDisplays();
}

function showConfirmModal(identifier, isTask = false, itemType = 'log') { refs.itemToProcess.value = identifier; refs.itemToProcess.dataset.itemType = itemType; refs.confirmDeleteButton.style.backgroundColor = 'var(--red)'; refs.confirmDeleteButton.textContent = 'Delete'; if (itemType === 'course') { refs.modalConfirmTitle.textContent = 'Delete Course?'; refs.modalConfirmText.textContent = `Are you sure you want to delete the course "${identifier}"? This will not affect existing log entries.`; } else if (itemType === 'task_permanent') { refs.modalConfirmTitle.textContent = 'Delete Task Permanently?'; refs.modalConfirmText.textContent = 'This will remove the task from history. Use "Done" if you just finished it.'; } else { refs.modalConfirmTitle.textContent = 'Are you sure?'; refs.modalConfirmText.textContent = 'Are you sure you want to delete this item? This action cannot be undone.'; } refs.confirmModal.style.display = 'flex'; }
function hideConfirmModal() { refs.itemToProcess.value = ''; refs.confirmModal.style.display = 'none'; }
function showEditModal(timestamp) { let item = state.allSessions.find(s => s.timestamp === timestamp); let itemType = 'session'; if (!item) { item = state.allScores.find(s => s.timestamp === timestamp); itemType = 'score'; } if (!item) return; refs.editTimestamp.value = timestamp; refs.editCourseSelect.value = item.course; refs.editNotes.value = item.notes || ''; refs.editError.textContent = ''; if (!editDatePickerInstance) { editDatePickerInstance = window.flatpickr(refs.editDatePicker, { dateFormat: "Y-m-d", defaultDate: new Date(timestamp) }); } else { editDatePickerInstance.setDate(new Date(timestamp)); } if (itemType === 'session') { refs.editSessionGroup.style.display = 'block'; refs.editDuration.value = item.duration; refs.editScoreGroup.style.display = 'none'; } else { refs.editSessionGroup.style.display = 'none'; refs.editScoreGroup.style.display = 'block'; refs.editScore.value = item.score; } refs.editModal.style.display = 'flex'; }
function hideEditModal() { refs.editModal.style.display = 'none'; }
function saveEdit() { const ts = refs.editTimestamp.value; const newCourse = refs.editCourseSelect.value; const newNotes = refs.editNotes.value.trim(); const newDateStr = refs.editDatePicker.value; let sessionItem = state.allSessions.find(s => s.timestamp === ts); let scoreItem = state.allScores.find(s => s.timestamp === ts); let activeItem = sessionItem || scoreItem; if (activeItem) { if (newDateStr) { const originalDateObj = new Date(ts); const newDateObj = new Date(newDateStr); newDateObj.setHours(originalDateObj.getHours(), originalDateObj.getMinutes(), originalDateObj.getSeconds()); activeItem.timestamp = newDateObj.toISOString(); } activeItem.course = newCourse; activeItem.notes = newNotes; if (sessionItem) { const newDuration = refs.editDuration.value; if (!/^\d{2}:\d{2}:\d{2}$/.test(newDuration)) { refs.editError.textContent = "Duration must be in HH:MM:SS format."; return; } const parts = newDuration.split(':').map(Number); activeItem.seconds = (parts[0] * 3600) + (parts[1] * 60) + parts[2]; activeItem.duration = newDuration; } else if (scoreItem) { const newScore = parseInt(refs.editScore.value, 10); if(isNaN(newScore) || newScore < 0 || newScore > 100){ refs.editError.textContent = 'Score must be a number from 0-100.'; return; } activeItem.score = newScore; } dataManager.saveData(); updateAllDisplays(); hideEditModal(); } }

function showPomodoroPrompt(phaseName, nextDuration) { 
    refs.pomodoroPromptTitle.textContent = "Phase Complete!"; 
    if (phaseName === 'studying') { 
        refs.pomodoroPromptText.textContent = "Break is over. Ready to focus?"; 
        refs.pomodoroPromptConfirmBtn.textContent = `Start Focus (${state.pomodoroFocusDuration}m)`; 
    } else { 
        refs.pomodoroPromptText.textContent = "Great job! Time for a break?"; 
        const breakType = phaseName === 'shortBreak' ? 'Short' : 'Long';
        const breakMins = phaseName === 'shortBreak' ? (state.pomodoroShortBreakDuration || 10) : (state.pomodoroLongBreakDuration || 20);
        refs.pomodoroPromptConfirmBtn.textContent = `Start ${breakType} Break (${breakMins}m)`; 
    } 
    refs.pomodoroPromptModal.style.display = 'flex'; 
}

function hidePomodoroPrompt() { refs.pomodoroPromptModal.style.display = 'none'; }
function showCoursesModal() { refs.coursesModal.style.display = 'flex'; refs.newCourseName.focus(); }
function hideCoursesModal() { refs.coursesModal.style.display = 'none'; }
function addCourse() { const name = refs.newCourseName.value.trim(); if (name && !state.allCourses.includes(name)) { state.allCourses.push(name); state.allCourses.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase())); dataManager.saveData(); updateAllDisplays(); refs.newCourseName.value = ''; } }
function deleteCourse(courseName) { state.allCourses = state.allCourses.filter(c => c !== courseName); dataManager.saveData(); updateAllDisplays(); }

function showSettingsModal() { 
    refs.settingsModal.style.display = 'flex'; 
    refs.streakTargetInput.value = state.streakTarget; 
    refs.streakMinTimeInput.value = state.streakMinMinutes;
    if(refs.deadlineUrgencyInput) refs.deadlineUrgencyInput.value = state.deadlineUrgencyDays;

    if(refs.settingFocusDuration) refs.settingFocusDuration.value = state.pomodoroFocusDuration || 50;
    if(refs.settingShortBreakDuration) refs.settingShortBreakDuration.value = state.pomodoroShortBreakDuration || 10;
    if(refs.settingLongBreakDuration) refs.settingLongBreakDuration.value = state.pomodoroLongBreakDuration || 20;
}

function hideSettingsModal() { refs.settingsModal.style.display = 'none'; }

function saveSettings() {
    const newSoundPath = refs.alarmSoundInput.value;
    if(newSoundPath) { refs.alarmSound.src = 'file://' + newSoundPath; localStorage.setItem('alarmSound', newSoundPath); refs.selectedAlarmFile.textContent = newSoundPath.split('\\').pop().split('/').pop(); }
    
    const target = parseInt(refs.streakTargetInput.value); if (target && target > 0) state.streakTarget = target;
    const minTime = parseInt(refs.streakMinTimeInput.value); if (minTime && minTime >= 0) state.streakMinMinutes = minTime;
    const urgency = parseInt(refs.deadlineUrgencyInput.value); if(urgency && urgency > 0) state.deadlineUrgencyDays = urgency;

    if(refs.settingFocusDuration) {
        const val = parseInt(refs.settingFocusDuration.value);
        if(val > 0) state.pomodoroFocusDuration = val;
    }
    if(refs.settingShortBreakDuration) {
        const val = parseInt(refs.settingShortBreakDuration.value);
        if(val > 0) state.pomodoroShortBreakDuration = val;
    }
    if(refs.settingLongBreakDuration) {
        const val = parseInt(refs.settingLongBreakDuration.value);
        if(val > 0) state.pomodoroLongBreakDuration = val;
    }

    dataManager.saveData(); updateAllDisplays(); hideSettingsModal();
}

function maximizeSystemVolume() { try { if (process.platform === 'darwin') { exec('osascript -e "set volume output volume 100"'); } else if (process.platform === 'win32') { const cmd = `powershell -WindowStyle Hidden -Command "$w=New-Object -ComObject WScript.Shell;for($i=0;$i-lt 50;$i++){$w.SendKeys([char]175)}"`; exec(cmd); } else if (process.platform === 'linux') { exec('amixer sset Master 100% || amixer -D pulse sset Master 100%'); } } catch (e) { console.error("Could not set system volume:", e); } }

function playAlarm(stop = false) { 
    if (stop) { 
        refs.alarmSound.pause(); 
        refs.alarmSound.currentTime = 0; 
        return;
    } 

    maximizeSystemVolume(); 

    // Check if we have a valid file source
    const currentSrc = refs.alarmSound.getAttribute('src');
    if (currentSrc && currentSrc !== '' && currentSrc !== 'file://') {
        refs.alarmSound.volume = 1.0; 
        refs.alarmSound.currentTime = 0; 
        refs.alarmSound.play().catch(e => { 
            console.warn("Could not play alarm file. Using fallback.", e); 
            playFallbackBeep();
        }); 
    } else {
        // Fallback if no file is selected
        playFallbackBeep();
    }
}

// Fallback Beep using Web Audio API (No files required)
function playFallbackBeep() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.type = 'sine';
        osc.frequency.value = 880; // A5
        gain.gain.value = 0.5;
        
        osc.start();
        
        // Beep pattern: Beep... Beep... Beep
        gain.gain.setValueAtTime(0.5, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
        osc.stop(ctx.currentTime + 0.6);

        // Repeat twice more
        setTimeout(() => {
            const osc2 = ctx.createOscillator();
            const gain2 = ctx.createGain();
            osc2.connect(gain2);
            gain2.connect(ctx.destination);
            osc2.frequency.value = 880;
            osc2.start();
            gain2.gain.setValueAtTime(0.5, ctx.currentTime);
            gain2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
            osc2.stop(ctx.currentTime + 0.6);
        }, 800);

        setTimeout(() => {
            const osc3 = ctx.createOscillator();
            const gain3 = ctx.createGain();
            osc3.connect(gain3);
            gain3.connect(ctx.destination);
            osc3.frequency.value = 880;
            osc3.start();
            gain3.gain.setValueAtTime(0.5, ctx.currentTime);
            gain3.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
            osc3.stop(ctx.currentTime + 0.6);
        }, 1600);

    } catch (e) {
        console.error("Audio Context Error:", e);
    }
}

function testAlarm() { const soundPath = localStorage.getItem('alarmSound') || ''; if (soundPath) { refs.alarmSound.src = 'file://' + soundPath; playAlarm(); } else { playAlarm(); /* Will trigger fallback */ } }
async function selectAlarmFile() { const filePath = await window.ipcRenderer.invoke('dialog:openFile'); if (filePath) { refs.alarmSoundInput.value = filePath; refs.selectedAlarmFile.textContent = filePath.split('\\').pop().split('/').pop(); } }

function showChartModal(type) { 
    refs.chartModal.style.display = 'flex'; 
    let option; 
    
    // Helper to resize chart after modal opens
    const resizeChart = (chart) => requestAnimationFrame(() => chart.resize());

    if (type === 'time') { 
        if (state.pieChartMode === 'trend') { 
            // *** TREND MODE ***
            refs.zoomedChartTitle.textContent = `Study Time Trend (Last ${state.trendChartSpan} Days)`; 
            
            // Now calling the correct function
            option = getTrendChartOptions(); 
            
            // Clean layout for Trend in Modal
            if(option.series && option.series[0] && option.series[0].type === 'bar') {
                option.legend.orient = 'horizontal';
                option.legend.right = 'auto';
                option.legend.left = 'center';
                option.title = null; // No title needed for bar chart
            }

        } else { 
            // *** PIE MODE (Total or Today) ***
            refs.zoomedChartTitle.textContent = `Study Time by Course (${state.pieChartMode === 'total' ? 'Total' : 'Today'})`; 
            option = getTimeChartOptions(); 
            
            // Fix Layout for Zoomed Pie
            if (option.series && option.series[0]) {
                option.series[0].center = ['50%', '50%']; // Center in modal
                option.series[0].radius = ['50%', '80%']; // Bigger pie
            }
            
            // Move Legend to Bottom
            option.legend = {
                bottom: 20,
                left: 'center',
                orient: 'horizontal'
            };
            
            // Add Center Text (Because HTML overlay is missing in modal)
            let totalSec = 0;
            state.allSessions.forEach(s => {
               if(state.pieChartMode === 'today') {
                   const todayStr = getLocalISODateString(new Date());
                   if(getLocalISODateString(new Date(s.timestamp)) === todayStr) totalSec += s.seconds;
               } else {
                   totalSec += s.seconds;
               }
            });
            const hrs = (totalSec / 3600).toFixed(1);
            
            option.title = {
                text: hrs + '\nHOURS',
                left: 'center',
                top: 'center',
                textStyle: { fontSize: 40, color: '#4a413a', fontWeight: 'bold' }
            };
        } 
        
        // Init Time Chart if needed
        if (!state.zoomedTimeChart) { 
            state.zoomedTimeChart = window.echarts.init(refs.zoomedChartContainer, null, { devicePixelRatio: 2 }); 
        } 
        
        // Critical: Clear previous options to prevent mixing Pie/Bar properties
        state.zoomedTimeChart.clear();
        state.zoomedTimeChart.setOption(option, { notMerge: true }); 
        resizeChart(state.zoomedTimeChart);
    
    } else if (type === 'score') { 
        // *** PERFORMANCE CHART ***
        refs.zoomedChartTitle.textContent = 'Performance Trend'; 
        option = getScoreChartOptions(); 
        
        if (!state.zoomedScoreChart) { 
            state.zoomedScoreChart = window.echarts.init(refs.zoomedChartContainer, null, { devicePixelRatio: 2 }); 
        } 
        
        state.zoomedScoreChart.clear();
        state.zoomedScoreChart.setOption(option, { notMerge: true }); 
        resizeChart(state.zoomedScoreChart);
    } 
}

function hideChartModal() { refs.chartModal.style.display = 'none'; }

module.exports = {
    init, showEventModal, hideEventModal, saveEvent, showConfirmModal, hideConfirmModal,
    showEditModal, hideEditModal, saveEdit, showCoursesModal, hideCoursesModal, addCourse, deleteCourse,
    showSettingsModal, hideSettingsModal, saveSettings, testAlarm, selectAlarmFile,
    showChartModal, hideChartModal, playAlarm,
    showPomodoroPrompt, hidePomodoroPrompt
};
</file>

<file path="js/state.js">
// --- All state variables ---
let allCourses = []; 
let allSessions = [], allScores = [], allEvents = [];
let lastSelectedCourse = null;

let calendar, timeChart, scoreChart;
let stopwatchTimer, pomodoroTimer, countdownTimer; 
let saveDataInterval = null;

let stopwatchSeconds = 0;
let stopwatchStartTime = null;
let isStopwatchRunning = false;
let isStopwatchPaused = false;

let pomodoroState = 'idle';
let pomodoroSecondsLeft = 50 * 60;
let pomodoroCycle = 0;
let isPomodoroPaused = false;
let pomodoroPausedTime = 0;
let pomodoroOriginalDuration = 0;
let pomodoroStartTime = null;
let nextPomodoroPhase = null;

// *** NEW: Customizable Pomodoro Timings (Defaults) ***
let pomodoroFocusDuration = 50;
let pomodoroShortBreakDuration = 10;
let pomodoroLongBreakDuration = 20;

let countdownSecondsLeft = 0;
let isCountdownRunning = false;
let isCountdownPaused = false;
let countdownPausedTime = 0;
let countdownStartTime = null;

let isSavingEvent = false; 
let zoomedTimeChart = null;
let zoomedScoreChart = null;
let eventModalPicker = null; 

let pieChartMode = 'trend'; 
let trendChartSpan = 7; 
let logViewMode = 'chrono'; 
let showCompletedTasks = false; 

let streakCount = 0;
let streakTarget = 7; 
let streakMinMinutes = 15; 
let isFocusMode = false;

let deadlineUrgencyDays = 60;

let calendarCurrentMonth = null;
let calendarCurrentYear = null;

module.exports = {
    allCourses, allSessions, allScores, allEvents, lastSelectedCourse,
    calendar, timeChart, scoreChart, stopwatchTimer, pomodoroTimer, countdownTimer, saveDataInterval,
    stopwatchSeconds, stopwatchStartTime, isStopwatchRunning, isStopwatchPaused,
    pomodoroState, pomodoroSecondsLeft, pomodoroCycle, isPomodoroPaused, pomodoroPausedTime, pomodoroOriginalDuration, pomodoroStartTime, nextPomodoroPhase,
    pomodoroFocusDuration, pomodoroShortBreakDuration, pomodoroLongBreakDuration, 
    countdownSecondsLeft, isCountdownRunning, isCountdownPaused, countdownPausedTime, countdownStartTime,
    isSavingEvent, zoomedTimeChart, zoomedScoreChart, eventModalPicker,
    pieChartMode, trendChartSpan, logViewMode, showCompletedTasks,
    streakCount, streakTarget, streakMinMinutes, isFocusMode,
    deadlineUrgencyDays, 
    calendarCurrentMonth, calendarCurrentYear
};
</file>

<file path="js/utils.js">
function getLocalISODateString(date) {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// --- NEW: Persian Date Converter (Jalaali Algorithm) ---
function toJalaali(gy, gm, gd) {
    var g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
    var gy2 = (gm > 2) ? (gy + 1) : gy;
    var days = 355666 + (365 * gy) + ~~((gy2 + 3) / 4) - ~~((gy2 + 99) / 100) + ~~((gy2 + 399) / 400) + gd + g_d_m[gm - 1];
    var jy = -1595 + (33 * ~~(days / 12053));
    days %= 12053;
    jy += 4 * ~~(days / 1461);
    days %= 1461;
    if (days > 365) { jy += ~~((days - 1) / 365); days = (days - 1) % 365; }
    var jm = (days < 186) ? 1 + ~~(days / 31) : 7 + ~~((days - 186) / 30);
    var jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
    return { jy: jy, jm: jm, jd: jd };
}

function getPersianDateString(dateObj) {
    if (!dateObj || isNaN(dateObj.getTime())) return "";
    const j = toJalaali(dateObj.getFullYear(), dateObj.getMonth() + 1, dateObj.getDate());
    const months = ["Farvardin", "Ordibehesht", "Khordad", "Tir", "Mordad", "Shahrivar", "Mehr", "Aban", "Azar", "Dey", "Bahman", "Esfand"];
    return `${months[j.jm - 1]} ${j.jd}`; // e.g., "Dey 16"
}

function getFullPersianDate(dateObj) {
    if (!dateObj || isNaN(dateObj.getTime())) return "";
    const j = toJalaali(dateObj.getFullYear(), dateObj.getMonth() + 1, dateObj.getDate());
    return `${j.jy}/${j.jm.toString().padStart(2, '0')}/${j.jd.toString().padStart(2, '0')}`; // e.g., "1403/10/16"
}

module.exports = {
    getLocalISODateString,
    getPersianDateString,
    getFullPersianDate,
    toJalaali  // <--- ADD THIS LINE
};
</file>

<file path="js/views.js">
let state, refs, showEventModal, logSession;
// IMPORT NEW UTILS
// Add toJalaali to the list inside the curly braces
const { getLocalISODateString, getPersianDateString, getFullPersianDate, toJalaali } = require('./utils');
function initializeCalendar() { 
    state.calendar = flatpickr(refs.studyCalendar, { 
        inline: true, 
        locale: 'fa', 
        altInput: true, 
        altFormat: "Y/m/d",
        dateFormat: "Y-m-d",
        
        onChange: (selectedDates) => { 
            if (!state.isSavingEvent && selectedDates.length) {
                updateLogDisplay(getLocalISODateString(selectedDates[0])); 
            }
        }, 

        // *** THE REAL BUILD: VISUAL INJECTION ***
        onDayCreate: (dObj, dStr, fp, dayElem) => { 
            // 1. Convert the cell's date to Jalaali
            const dateObj = dayElem.dateObj;
            const j = toJalaali(dateObj.getFullYear(), dateObj.getMonth() + 1, dateObj.getDate());
            
            // 2. Add the Persian number into the HTML
            dayElem.innerHTML += `<span class="jalaali-date">${j.jd}</span>`;

            // 3. Existing Event Logic
            const date = getLocalISODateString(dateObj); 
            const studyDays = new Set(state.allSessions.map(s => getLocalISODateString(new Date(s.timestamp)))); 
            if (studyDays.has(date)) { dayElem.classList.add("study-day"); } 
            
            const eventsOnThisDay = state.allEvents.filter(e => e.date === date && !e.isDone); 
            if (eventsOnThisDay.length > 0) { 
                dayElem.classList.add("event-day"); 
                // Add an event dot indicator
                dayElem.innerHTML += `<span class="event-dot"></span>`;
                // Use Tippy for tooltip instead of native title
                dayElem.setAttribute('data-tooltip', eventsOnThisDay.map(e => e.title).join('\n'));
            } 
            
            dayElem.addEventListener('contextmenu', (e) => { e.preventDefault(); showEventModal(dayElem.dateObj); }); 
        } 
    }); 
}
const { delegate } = require('tippy.js');

function initializeGlobalTooltips() { delegate('body', { target: '[data-tooltip]', content(reference) { return reference.dataset.tooltip; }, allowHTML: false, placement: 'top', animation: 'fade', delay: 15, duration: 0 }); }
function init(appState, uiRefs, eventModalFn, logSessionFn) { state = appState; refs = uiRefs; showEventModal = eventModalFn; logSession = logSessionFn; }
function updateStreakDisplay() { refs.streakCount.textContent = state.streakCount; if (state.streakCount > 0) { refs.streakContainer.classList.add('active-streak'); } else { refs.streakContainer.classList.remove('active-streak'); } if (state.streakCount >= state.streakTarget) { refs.streakContainer.classList.add('target-hit'); } else { refs.streakContainer.classList.remove('target-hit'); } }
function toggleFocusModeVisuals() { if (state.isFocusMode) { document.body.classList.add('focus-mode'); refs.btnFocusMode.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Exit Zen Mode`; refs.btnFocusMode.dataset.tooltip = "Exit Zen Mode"; } else { document.body.classList.remove('focus-mode'); refs.btnFocusMode.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg>`; refs.btnFocusMode.dataset.tooltip = "Enter Focus Mode"; } }
const icons = { edit: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>`, delete: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>`, check: `âœ”` };

function updateLogDisplay(filterDate = null) { 
    refs.sessionLog.innerHTML = ''; 
    let combinedLog = [...state.allSessions, ...state.allScores]; 
    if (filterDate) { 
        refs.showAllButton.hidden = false; 
        combinedLog = combinedLog.filter(item => getLocalISODateString(new Date(item.timestamp)) === filterDate); 
    } else { 
        refs.showAllButton.hidden = true; 
    } 
    
    if (state.logViewMode === 'chrono') { 
        refs.btnLogChrono.classList.add('active'); 
        refs.btnLogTopic.classList.remove('active'); 
        combinedLog.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).forEach(item => { 
            const el=document.createElement('div'); 
            const d=new Date(item.timestamp); 
            
            // --- PERSIAN DATE FORMAT ---
            const pDate = getPersianDateString(d);
            const tTime = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
            const fd = `${pDate}, ${tTime}`;
            // ---------------------------

            const buttons = `<div class="log-meta"><span class="log-date">${fd}</span><div class="log-actions"><button class="action-icon-btn edit edit-btn" data-timestamp="${item.timestamp}" data-tooltip="Edit">${icons.edit}</button><button class="action-icon-btn delete delete-btn" data-timestamp="${item.timestamp}" data-tooltip="Delete">${icons.delete}</button></div></div>`; 
            if(item.type==='session'){ el.className='log-item'; el.innerHTML=`<span class="log-course">${item.course}</span>${buttons}<div class="log-duration">${item.duration}</div><div class="log-notes">${item.notes}</div>`; } else { el.className='score-item'; el.innerHTML=`<span class="log-course">${item.course}</span>${buttons}<div class="score-value">${item.score}%</div><div class="log-notes">${item.notes}</div>`; } refs.sessionLog.appendChild(el); 
        }); 
    } else { 
        refs.btnLogChrono.classList.remove('active'); 
        refs.btnLogTopic.classList.add('active'); 
        const grouped = {}; 
        combinedLog.filter(item => item.notes && item.notes.trim() !== '').forEach(item => { if (!grouped[item.course]) grouped[item.course] = []; grouped[item.course].push(item); }); Object.keys(grouped).sort().forEach(course => { const courseHeader = document.createElement('h3'); courseHeader.className = 'log-course-header'; courseHeader.textContent = course; refs.sessionLog.appendChild(courseHeader); grouped[course].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach((item, index) => { const el=document.createElement('div'); const cleanNote = item.notes.replace(/\(stopped early\)/g, '').trim(); if (item.type === 'session') { el.className = 'log-item-minimal'; el.innerHTML = `<span class="log-date-minimal">${index + 1}.</span> ${cleanNote}`; } else { el.className = 'log-item-minimal'; el.innerHTML = `<span class="log-date-minimal">${index + 1}.</span> <strong>${item.score}%</strong> ${cleanNote}`; } refs.sessionLog.appendChild(el); }); }); 
    } 
}

function updateTaskDashboard() {
    refs.taskList.innerHTML = ''; 
    const now = new Date(); now.setHours(0,0,0,0);
    
    let filteredEvents;
    if (state.showCompletedTasks) { refs.btnToggleTasks.textContent = "Show Pending"; filteredEvents = state.allEvents.filter(e => e.isDone); } 
    else { refs.btnToggleTasks.textContent = "Show Completed"; filteredEvents = state.allEvents.filter(e => !e.isDone); }
    
    filteredEvents.sort((a,b) => {
        const dateA = new Date(a.date); const dateB = new Date(b.date);
        if (state.showCompletedTasks) return dateB - dateA; return dateA - dateB;
    });
    
    if (filteredEvents.length === 0) { refs.taskList.innerHTML = `<div style="text-align:center; color:#999; margin-top:20px; font-size:0.85rem;">No tasks.</div>`; return; }

    filteredEvents.forEach(event => {
        const eventDate = new Date(event.date);
        eventDate.setMinutes(eventDate.getMinutes() + eventDate.getTimezoneOffset());
        const daysLeft = Math.ceil((eventDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
        
        let countdownText = ''; let itemClass = 'task-item';
        
        if (state.showCompletedTasks) {
            itemClass += ' completed'; countdownText = "Done";
        } else {
            if(daysLeft < 0) { itemClass += ' overdue'; countdownText = `${-daysLeft}d passed`; } 
            else if (daysLeft === 0) { itemClass += ' warning-urgent'; countdownText = 'Today'; } 
            else if (daysLeft <= 3) { itemClass += ' warning-urgent'; countdownText = `${daysLeft}d left`; } 
            else { countdownText = `${daysLeft}d left`; }
        }
        
        // --- PERSIAN DATE ---
        const formattedDate = getPersianDateString(eventDate);
        // --------------------
        
        let barFill = 0;
        if (state.showCompletedTasks) {
            barFill = 100;
        } else {
            const maxDays = state.deadlineUrgencyDays || 60;
            if (daysLeft <= 0) { barFill = 100; }
            else { barFill = Math.max(0, 100 - ((daysLeft / maxDays) * 100)); }
        }

        const item = document.createElement('div'); item.className = itemClass;
        
        let controlsHtml = '';
        if (state.showCompletedTasks) {
            controlsHtml = `
                <button class="action-icon-btn edit task-edit-btn" data-timestamp="${event.timestamp}" data-tooltip="Edit">${icons.edit}</button>
                <button class="action-icon-btn delete task-delete-btn" data-timestamp="${event.timestamp}" data-tooltip="Delete Permanently">${icons.delete}</button>
            `;
        } else {
            controlsHtml = `
                <span class="task-date" style="margin-right:8px; font-weight:600; color:${daysLeft < 3 ? 'var(--danger)' : 'var(--text-muted)'}">${countdownText}</span>
                <button class="action-icon-btn edit task-edit-btn" data-timestamp="${event.timestamp}" data-tooltip="Edit" style="margin-right:4px;">${icons.edit}</button>
                <button class="task-done-btn" data-timestamp="${event.timestamp}" data-tooltip="Mark Done">âœ”</button>
            `;
        }

        item.innerHTML = `<div class="task-header">
                            <div>
                                <span class="task-title">${event.title}</span>
                                <span class="task-date" style="display:block; margin-top:2px;">${formattedDate}</span>
                            </div>
                            <div class="task-controls" style="display:flex; align-items:center;">${controlsHtml}</div>
                          </div>
                          <div class="task-bar-bg"><div class="task-bar-fg" style="width: ${barFill}%;"></div></div>`;
        refs.taskList.appendChild(item);
    });
}



function updateCalendar() { 
    // Only try to redraw if the calendar exists AND has the function
    if (state.calendar && typeof state.calendar.redraw === 'function') { 
        state.calendar.redraw(); 
    } 
}
function resetCalendarToToday() { const today = new Date(); if (state.calendar) { state.calendar.setDate(today, true); state.calendar.jumpToDate(today); } updateLogDisplay(getLocalISODateString(today)); }

// Initialize Event Modal Picker (Also Persian)
function initializeEventModalPicker() { 
    state.eventModalPicker = flatpickr(refs.eventDatePicker, { 
        dateFormat: "Y-m-d", 
        altInput: true,
        altFormat: "Y/m/d", 
        locale: 'fa'
    }); 
}


function populateCourses() { refs.courseSelect.innerHTML = ''; refs.scoreCourseSelect.innerHTML = ''; refs.editCourseSelect.innerHTML = ''; refs.pomodoroCourseSelect.innerHTML = ''; refs.countdownCourseSelect.innerHTML = ''; state.allCourses.forEach(c => { const o1=document.createElement('option');o1.value=c;o1.textContent=c;refs.courseSelect.appendChild(o1); const o2=document.createElement('option');o2.value=c;o2.textContent=c;refs.scoreCourseSelect.appendChild(o2); const o3=document.createElement('option');o3.value=c;o3.textContent=c;refs.editCourseSelect.appendChild(o3); const o4=document.createElement('option');o4.value=c;o4.textContent=c;refs.pomodoroCourseSelect.appendChild(o4); const o5=document.createElement('option');o5.value=c;o5.textContent=c;refs.countdownCourseSelect.appendChild(o5); }); if (state.lastSelectedCourse && state.allCourses.includes(state.lastSelectedCourse)) { refs.courseSelect.value = state.lastSelectedCourse; refs.scoreCourseSelect.value = state.lastSelectedCourse; refs.editCourseSelect.value = state.lastSelectedCourse; refs.pomodoroCourseSelect.value = state.lastSelectedCourse; refs.countdownCourseSelect.value = state.lastSelectedCourse; } }
function updateCourseEditorList() { refs.courseListEditor.innerHTML = ''; state.allCourses.forEach(course => { const item = document.createElement('div'); item.className = 'course-list-item'; item.style.cssText = "display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee; align-items:center;"; item.innerHTML = `<span>${course}</span><button class="action-icon-btn delete course-delete-btn" data-course="${course}">${icons.delete}</button>`; refs.courseListEditor.appendChild(item); }); }
function setLogViewMode(mode) { state.logViewMode = mode; updateLogDisplay(); }

module.exports = { init, updateLogDisplay, updateTaskDashboard, updateStreakDisplay, toggleFocusModeVisuals, initializeCalendar, updateCalendar, resetCalendarToToday, initializeEventModalPicker, populateCourses, updateCourseEditorList, setLogViewMode, initializeGlobalTooltips };
</file>

<file path="js/listeners.js">
let refs, timers, modals, charts, views, dataManager, state, updateAllDisplays;

function init(appState, uiRefs, timerFuncs, modalFuncs, chartFuncs, viewFuncs, dataMgr, updateAllDisplaysFn) {
    state = appState;
    refs = uiRefs;
    timers = timerFuncs;
    modals = modalFuncs;
    charts = chartFuncs;
    views = viewFuncs;
    dataManager = dataMgr; 
    updateAllDisplays = updateAllDisplaysFn;

    const handleCourseChange = (event) => { const newCourse = event.target.value; state.lastSelectedCourse = newCourse; refs.courseSelect.value = newCourse; refs.scoreCourseSelect.value = newCourse; refs.pomodoroCourseSelect.value = newCourse; refs.countdownCourseSelect.value = newCourse; dataManager.saveLastSelectedCourse(); };
    refs.courseSelect.addEventListener('change', handleCourseChange); refs.scoreCourseSelect.addEventListener('change', handleCourseChange); refs.pomodoroCourseSelect.addEventListener('change', handleCourseChange); refs.countdownCourseSelect.addEventListener('change', handleCourseChange);
    
    // STOPWATCH
    refs.startButton.addEventListener('click', () => { timers.startTimer(); });
    refs.stopButton.addEventListener('click', timers.stopTimer);
    if(refs.resetButton) refs.resetButton.addEventListener('click', timers.resetStopwatch);

    // POMODORO
    refs.pomodoroStartBtn.addEventListener('click', () => { 
        state.pomodoroCycle = 0; 
        const duration = (state.pomodoroFocusDuration || 50) * 60;
        timers.beginNewPomodoroPhase(duration, 'studying'); 
    });
    refs.pomodoroPauseResumeBtn.addEventListener('click', timers.togglePomodoroPause);
    refs.pomodoroStopBtn.addEventListener('click', timers.stopPomodoro);
    if (refs.pomodoroSkipBtn) refs.pomodoroSkipBtn.addEventListener('click', timers.skipPomodoroPhase);
    if (refs.pomodoroResetBtn) refs.pomodoroResetBtn.addEventListener('click', timers.resetPomodoro);

    // COUNTDOWN
    refs.countdownStartPauseBtn.addEventListener('click', () => { timers.startCountdownTimer(); });
    refs.countdownStopBtn.addEventListener('click', timers.stopCountdownTimer);
    refs.countdownResetBtn.addEventListener('click', timers.resetCountdownTimer);
    
    // LOG & GENERAL
    refs.logScoreButton.addEventListener('click', () => { if (dataManager.logScore()) { updateAllDisplays(); } });
    refs.showAllButton.addEventListener('click', () => { views.updateLogDisplay(); if (state.calendar) { state.calendar.clear(); } });
    if(refs.btnCalendarToday) { refs.btnCalendarToday.addEventListener('click', () => { views.resetCalendarToToday(); }); }

    // MODALS & ACTIONS
    refs.saveEventButton.addEventListener('click', modals.saveEvent);
    refs.cancelEventButton.addEventListener('click', () => { modals.hideEventModal(); views.updateCalendar(); });
    refs.confirmDeleteButton.addEventListener('click', () => { const identifier = refs.itemToProcess.value; const itemType = refs.itemToProcess.dataset.itemType || 'log'; if (!identifier) return; if (itemType === 'course') { modals.deleteCourse(identifier); } else if (itemType === 'task_permanent') { state.allEvents = state.allEvents.filter(e => e.timestamp !== identifier); dataManager.saveData(); updateAllDisplays(); } else { dataManager.deleteItem(identifier); updateAllDisplays(); } modals.hideConfirmModal(); });
    refs.cancelDeleteButton.addEventListener('click', modals.hideConfirmModal);
    refs.saveEditButton.addEventListener('click', modals.saveEdit);
    refs.cancelEditButton.addEventListener('click', modals.hideEditModal);
    refs.closeChartModalButton.addEventListener('click', modals.hideChartModal);
    
    // CHARTS
    refs.btnPieTotal.addEventListener('click', () => charts.setPieMode('total'));
    refs.btnPieToday.addEventListener('click', () => charts.setPieMode('today'));
    refs.btnPieTrend.addEventListener('click', () => charts.setPieMode('trend'));
    refs.trendSpanSelect.addEventListener('change', (e) => { state.trendChartSpan = parseInt(e.target.value); charts.updateTimeChart(); });
    refs.btnToggleTasks.addEventListener('click', () => { state.showCompletedTasks = !state.showCompletedTasks; views.updateTaskDashboard(); });
    
    // TIMER TABS & MODES
    refs.btnTimerStopwatch.addEventListener('click', () => timers.setTimerMode('stopwatch'));
    refs.btnTimerPomodoro.addEventListener('click', () => timers.setTimerMode('pomodoro'));
    refs.btnTimerCountdown.addEventListener('click', () => timers.setTimerMode('countdown'));
    refs.btnFocusMode.addEventListener('click', () => { state.isFocusMode = !state.isFocusMode; views.toggleFocusModeVisuals(); });
    refs.btnLogChrono.addEventListener('click', () => views.setLogViewMode('chrono'));
    refs.btnLogTopic.addEventListener('click', () => views.setLogViewMode('topic'));
    
    // SETTINGS & DATA
    refs.globalSettingsBtn.addEventListener('click', modals.showSettingsModal);
    refs.manageCoursesFromSettingsBtn.addEventListener('click', modals.showCoursesModal);
    refs.closeCoursesModalBtn.addEventListener('click', modals.hideCoursesModal);
    refs.addCourseBtn.addEventListener('click', modals.addCourse);
    refs.courseListEditor.addEventListener('click', (event) => { const btn = event.target.closest('.course-delete-btn'); if (btn) { const courseName = btn.dataset.course; modals.showConfirmModal(courseName, false, 'course'); } });
    refs.closeSettingsModalBtn.addEventListener('click', modals.hideSettingsModal);
    refs.saveSettingsBtn.addEventListener('click', modals.saveSettings);
    refs.testAlarmBtn.addEventListener('click', modals.testAlarm);
    refs.selectAlarmBtn.addEventListener('click', modals.selectAlarmFile);
    refs.exportDataBtn.addEventListener('click', dataManager.exportData);
    refs.importDataBtn.addEventListener('click', () => refs.importFileInput.click());
    refs.importFileInput.addEventListener('change', (event) => { if (event.target.files.length > 0) { dataManager.importData(event.target.files[0]); } });
    
    // LISTS
    refs.sessionLog.addEventListener('click', (event) => { const deleteBtn = event.target.closest('.delete-btn'); const editBtn = event.target.closest('.edit-btn'); if (deleteBtn) { const ts = deleteBtn.dataset.timestamp; modals.showConfirmModal(ts, false, 'log'); } else if (editBtn) { const ts = editBtn.dataset.timestamp; modals.showEditModal(ts); } });
    refs.taskList.addEventListener('click', (event) => { const doneBtn = event.target.closest('.task-done-btn'); const deleteBtn = event.target.closest('.task-delete-btn'); const editBtn = event.target.closest('.task-edit-btn'); if (doneBtn) { const ts = doneBtn.dataset.timestamp; const eventIndex = state.allEvents.findIndex(e => e.timestamp === ts); if (eventIndex > -1) { state.allEvents[eventIndex].isDone = true; dataManager.saveData(); updateAllDisplays(); } } else if (deleteBtn) { const ts = deleteBtn.dataset.timestamp; modals.showConfirmModal(ts, false, 'task_permanent'); } else if (editBtn) { const ts = editBtn.dataset.timestamp; modals.showEventModal(null, ts); } });
    
    if (state.timeChart) {
        state.timeChart.on('click', (params) => {
            if (params.componentType === 'series') {
                modals.showChartModal('time');
            }
        });
    }
    if (state.scoreChart) {
        state.scoreChart.on('click', () => modals.showChartModal('score'));
    }

    refs.pomodoroPromptConfirmBtn.addEventListener('click', () => { if (state.nextPomodoroPhase) { timers.beginNewPomodoroPhase(state.nextPomodoroPhase.duration, state.nextPomodoroPhase.name); modals.hidePomodoroPrompt(); modals.playAlarm(true); } });
    refs.pomodoroPromptStopBtn.addEventListener('click', () => { timers.stopPomodoro(); modals.hidePomodoroPrompt(); modals.playAlarm(true); });
}

module.exports = { init };
</file>

<file path="js/timers.js">
let state, refs, logSession, playAlarm, updateAllDisplays, saveData, saveTimerProgress;
const modals = require('./modals'); 

function init(appState, uiRefs, logSessionFn, playAlarmFn, updateAllDisplaysFn, saveDataFn, saveTimerProgressFn) {
    state = appState;
    refs = uiRefs;
    logSession = logSessionFn;
    playAlarm = playAlarmFn;
    updateAllDisplays = updateAllDisplaysFn;
    saveData = saveDataFn;
    saveTimerProgress = saveTimerProgressFn;

    // Restore state if running
    if (state.pomodoroState !== 'idle') {
        refs.pomodoroStartControls.classList.add('hidden');
        refs.pomodoroRunningControls.classList.remove('hidden');
        refs.pomodoroPauseResumeBtn.disabled = false;
        refs.pomodoroStopBtn.disabled = false;
        if(refs.pomodoroResetBtn) refs.pomodoroResetBtn.disabled = false;
        if(refs.pomodoroSkipBtn) refs.pomodoroSkipBtn.disabled = false;
        refs.pomodoroPauseResumeBtn.textContent = state.isPomodoroPaused ? "Resume" : "Pause";
        
        if(state.pomodoroState === 'studying') {
             refs.pomodoroStatus.textContent = "PHASE: FOCUS";
             refs.pomodoroStatus.classList.remove('break-mode');
        } else {
             refs.pomodoroStatus.textContent = "PHASE: BREAK";
             refs.pomodoroStatus.classList.add('break-mode');
        }
    }

    if (state.isStopwatchRunning || state.isStopwatchPaused) {
        refs.stopButton.classList.remove('hidden');
        refs.resetButton.classList.remove('hidden');
        refs.stopButton.disabled = false;
        refs.resetButton.disabled = false;
        refs.startButton.textContent = state.isStopwatchPaused ? "Resume" : "Pause";
        refs.courseSelect.disabled = true;
    }

    if (state.isCountdownRunning || state.isCountdownPaused) {
        refs.countdownStopBtn.classList.remove('hidden');
        refs.countdownResetBtn.classList.remove('hidden');
        refs.countdownStopBtn.disabled = false;
        refs.countdownResetBtn.disabled = false;
        refs.countdownStartPauseBtn.textContent = state.isCountdownPaused ? "Resume" : "Pause";
    }
}

function updateTimerTabIndicators() {
    refs.btnTimerStopwatch.classList.toggle('running', state.isStopwatchRunning || state.isStopwatchPaused);
    refs.btnTimerPomodoro.classList.toggle('running', state.pomodoroState !== 'idle');
    refs.btnTimerCountdown.classList.toggle('running', state.isCountdownRunning || state.isCountdownPaused);
}

function updatePomodoroDisplay() {
    if (state.pomodoroState === 'idle') {
        state.pomodoroSecondsLeft = state.pomodoroFocusDuration * 60;
        refs.pomodoroTimerDisplay.textContent = formatCountdown(state.pomodoroSecondsLeft);
    }
}

function stopAndLogRunningTimers(excludeTimerType) {
    if (excludeTimerType !== 'stopwatch' && (state.isStopwatchRunning || state.isStopwatchPaused)) stopTimer();
    if (excludeTimerType !== 'pomodoro' && state.pomodoroState !== 'idle') stopPomodoro();
    if (excludeTimerType !== 'countdown' && (state.isCountdownRunning || state.isCountdownPaused)) stopCountdownTimer();
}

// --- STOPWATCH ---
function startTimer() { 
    stopAndLogRunningTimers('stopwatch');
    
    if (state.isStopwatchRunning) {
        // Pause logic
        pauseTimer();
    } else if (state.isStopwatchPaused) {
        // Resume logic
        state.isStopwatchRunning = true; 
        state.isStopwatchPaused = false;
        refs.startButton.textContent = "Pause";
        // Buttons already visible
    } else {
        // Start fresh
        state.isStopwatchRunning = true; 
        state.isStopwatchPaused = false;
        refs.startButton.textContent = "Pause"; 
        
        // SHOW BUTTONS
        refs.stopButton.classList.remove('hidden');
        refs.resetButton.classList.remove('hidden');
        refs.stopButton.disabled = false; 
        refs.resetButton.disabled = false; 
        refs.courseSelect.disabled = true; 
        
        if (state.stopwatchStartTime === null) { state.stopwatchStartTime = Date.now(); state.stopwatchSeconds = 0; } 
        else { state.stopwatchStartTime = Date.now() - (state.stopwatchSeconds * 1000); }
        
        state.stopwatchTimer = setInterval(() => { 
            state.stopwatchSeconds = Math.floor((Date.now() - state.stopwatchStartTime) / 1000);
            refs.timerDisplay.textContent = formatTime(state.stopwatchSeconds); saveTimerProgress(); 
        }, 1000);
    }
    updateTimerTabIndicators(); saveTimerProgress(); 
}

function pauseTimer() {
    clearInterval(state.stopwatchTimer);
    state.isStopwatchRunning = false; state.isStopwatchPaused = true;
    refs.startButton.textContent = "Resume"; updateTimerTabIndicators(); saveTimerProgress(); 
}
    
function stopTimer() { 
    clearInterval(state.stopwatchTimer); 
    if (state.stopwatchStartTime && state.stopwatchSeconds >= 1) {
        refs.timerError.textContent = ""; 
        logSession(refs.courseSelect.value, state.stopwatchSeconds, refs.sessionNotes.value, new Date(state.stopwatchStartTime).toISOString()); 
        updateAllDisplays();
    }
    resetStopwatch();
    saveData(); 
}

function resetStopwatch() {
    clearInterval(state.stopwatchTimer);
    state.isStopwatchRunning = false; 
    state.isStopwatchPaused = false;
    state.stopwatchSeconds = 0; 
    state.stopwatchStartTime = null;
    
    refs.timerDisplay.textContent = formatTime(0);
    refs.startButton.textContent = "Start";
    
    // HIDE BUTTONS
    refs.stopButton.classList.add('hidden');
    refs.resetButton.classList.add('hidden');
    refs.stopButton.disabled = true; 
    refs.resetButton.disabled = true; 
    
    refs.courseSelect.disabled = false;
    
    updateTimerTabIndicators();
    localStorage.removeItem('activeTimer');
}

// --- POMODORO ---
function beginNewPomodoroPhase(durationInSeconds, stateName) {
    stopAndLogRunningTimers('pomodoro');
    state.pomodoroOriginalDuration = durationInSeconds;
    if (stateName === 'studying') {
        state.pomodoroStartTime = Date.now();
        refs.pomodoroStatus.textContent = "PHASE: FOCUS";
        refs.pomodoroStatus.classList.remove('break-mode');
    } else {
        refs.pomodoroStatus.textContent = "PHASE: BREAK";
        refs.pomodoroStatus.classList.add('break-mode');
    }
    
    // Switch Panels
    refs.pomodoroStartControls.classList.add('hidden');
    refs.pomodoroRunningControls.classList.remove('hidden');
    
    // Enable buttons
    refs.pomodoroPauseResumeBtn.disabled = false;
    refs.pomodoroStopBtn.disabled = false;
    refs.pomodoroResetBtn.disabled = false;
    refs.pomodoroSkipBtn.disabled = false;
    
    state.isPomodoroPaused = false;
    startPomodoroCountdown(durationInSeconds, stateName);
}

function handlePomodoroCompletion(isSkipped = false) {
    clearInterval(state.pomodoroTimer);
    if(!isSkipped) playAlarm(); 

    if (state.pomodoroState === 'studying') {
        const elapsed = isSkipped ? (state.pomodoroOriginalDuration - state.pomodoroSecondsLeft) : state.pomodoroOriginalDuration;
        if (elapsed > 0) {
            logSession(refs.pomodoroCourseSelect.value, elapsed, refs.pomodoroNotes.value.trim(), new Date(state.pomodoroStartTime).toISOString());
            updateAllDisplays();
        }
        refs.pomodoroNotes.value = '';
        state.pomodoroCycle += 1;
        let nextBreakDuration, nextBreakName;
        if (state.pomodoroCycle >= 4) { nextBreakDuration = state.pomodoroLongBreakDuration * 60; nextBreakName = 'longBreak'; } 
        else { nextBreakDuration = state.pomodoroShortBreakDuration * 60; nextBreakName = 'shortBreak'; }
        beginNewPomodoroPhase(nextBreakDuration, nextBreakName);
    } else {
        if(!isSkipped) setTimeout(() => playAlarm(true), 15000); 
        state.nextPomodoroPhase = { duration: state.pomodoroFocusDuration * 60, name: 'studying' };
        modals.showPomodoroPrompt('studying', state.pomodoroFocusDuration * 60);
        state.pomodoroState = 'idle';
        refs.pomodoroStatus.textContent = "COMPLETED";
        updateTimerTabIndicators();
    }
}

function skipPomodoroPhase() { handlePomodoroCompletion(true); }

function startPomodoroCountdown(durationInSeconds, stateName) {
    clearInterval(state.pomodoroTimer); 
    state.pomodoroState = stateName;
    state.pomodoroSecondsLeft = durationInSeconds;
    refs.pomodoroPauseResumeBtn.textContent = "Pause";

    let pomodoroStartTimeForInterval = Date.now();
    state.pomodoroTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - pomodoroStartTimeForInterval) / 1000);
        state.pomodoroSecondsLeft = durationInSeconds - elapsed;
        if (state.pomodoroSecondsLeft < 0) state.pomodoroSecondsLeft = 0;
        refs.pomodoroTimerDisplay.textContent = formatCountdown(state.pomodoroSecondsLeft);
        saveTimerProgress();
        if (state.pomodoroSecondsLeft <= 0) handlePomodoroCompletion(false);
    }, 1000);
    updateTimerTabIndicators(); saveTimerProgress(); 
}

function togglePomodoroPause() {
    if (state.isPomodoroPaused) {
        state.isPomodoroPaused = false; refs.pomodoroPauseResumeBtn.textContent = "Pause";
        startPomodoroCountdown(state.pomodoroPausedTime, state.pomodoroState);
    } else {
        state.isPomodoroPaused = true; clearInterval(state.pomodoroTimer);
        state.pomodoroPausedTime = state.pomodoroSecondsLeft; refs.pomodoroPauseResumeBtn.textContent = "Resume";
    }
    saveTimerProgress();
}

function stopPomodoro() {
    clearInterval(state.pomodoroTimer);
    playAlarm(true);
    if (state.pomodoroState === 'studying') {
        const elapsedSeconds = state.pomodoroOriginalDuration - state.pomodoroSecondsLeft;
        if (elapsedSeconds >= 1) { 
            logSession(refs.pomodoroCourseSelect.value, elapsedSeconds, refs.pomodoroNotes.value.trim(), new Date(state.pomodoroStartTime).toISOString());
            updateAllDisplays();
            refs.pomodoroNotes.value = '';
        }
    }
    resetPomodoro();
    saveData(); 
}

function resetPomodoro() {
    // Back to default (Start button only)
    clearInterval(state.pomodoroTimer);
    state.pomodoroState = 'idle';
    state.isPomodoroPaused = false;
    state.pomodoroSecondsLeft = state.pomodoroFocusDuration * 60;
    state.pomodoroStartTime = null;
    
    refs.pomodoroTimerDisplay.textContent = formatCountdown(state.pomodoroFocusDuration * 60);
    refs.pomodoroStatus.textContent = "";
    
    // BACK TO DEFAULT VIEW
    refs.pomodoroStartControls.classList.remove('hidden');
    refs.pomodoroRunningControls.classList.add('hidden');
    
    updateTimerTabIndicators();
    localStorage.removeItem('activeTimer');
}

// --- COUNTDOWN ---
function startCountdownTimer(durationInSeconds) {
    stopAndLogRunningTimers('countdown');
    
    // 1. Determine the duration if not provided (e.g. Button Click)
    if (durationInSeconds === undefined) {
        if (state.isCountdownPaused) {
            // If Resuming, use the time left
            durationInSeconds = state.countdownSecondsLeft;
        } else {
            // If Fresh Start, calculate from inputs
            const h = parseInt(refs.countdownHours.value) || 0; 
            const m = parseInt(refs.countdownMinutes.value) || 0; 
            const s = parseInt(refs.countdownSeconds.value) || 0;
            durationInSeconds = (h * 3600) + (m * 60) + s;
        }
    }

    // 2. Button Logic (Pause/Resume/Start)
    if (state.isCountdownRunning) {
        pauseCountdownTimer();
        return;
    } 
    
    // We are starting or resuming
    if (state.isCountdownPaused) {
        // Resume UI
        state.isCountdownRunning = true; 
        state.isCountdownPaused = false;
        refs.countdownStartPauseBtn.textContent = "Pause";
    } else {
        // Fresh Start UI & State
        if (durationInSeconds <= 0) return; 

        // Save inputs only on fresh start
        const h = parseInt(refs.countdownHours.value) || 0; 
        const m = parseInt(refs.countdownMinutes.value) || 0; 
        const s = parseInt(refs.countdownSeconds.value) || 0;
        localStorage.setItem('countdownValues', JSON.stringify({ h, m, s }));
        
        state.countdownStartTime = Date.now(); 
        state.countdownOriginalDuration = durationInSeconds;
        state.countdownSecondsLeft = durationInSeconds;
        
        state.isCountdownRunning = true; 
        state.isCountdownPaused = false;
        
        refs.countdownStartPauseBtn.textContent = "Pause"; 
        refs.countdownStopBtn.classList.remove('hidden');
        refs.countdownResetBtn.classList.remove('hidden');
        refs.countdownStopBtn.disabled = false;
        refs.countdownResetBtn.disabled = false;
    }

    // 3. Interval Logic
    clearInterval(state.countdownTimer); 
    
    // The interval calculates time passed since THIS specific start/resume click
    let countdownStartTimeForInterval = Date.now();
    // We count down from whatever durationInSeconds was determined in step 1
    const startDuration = durationInSeconds; 

    state.countdownTimer = setInterval(() => {
        if(state.isCountdownPaused) return;

        const elapsed = Math.floor((Date.now() - countdownStartTimeForInterval) / 1000);
        state.countdownSecondsLeft = startDuration - elapsed;
        
        if (state.countdownSecondsLeft < 0) state.countdownSecondsLeft = 0;
        refs.countdownTimerDisplay.textContent = formatTime(state.countdownSecondsLeft);
        saveTimerProgress();

        if (state.countdownSecondsLeft <= 0) {
            clearInterval(state.countdownTimer); 
            playAlarm();
            logSession(refs.countdownCourseSelect.value, state.countdownOriginalDuration, refs.countdownNotes.value.trim(), new Date(state.countdownStartTime).toISOString());
            updateAllDisplays(); 
            refs.countdownNotes.value = '';
            setTimeout(() => { playAlarm(true); resetCountdownTimer(); }, 10000);
        }
    }, 1000);
    
    updateTimerTabIndicators(); 
    saveTimerProgress();
}

function pauseCountdownTimer() {
    clearInterval(state.countdownTimer); 
    state.isCountdownRunning = false; state.isCountdownPaused = true; state.countdownPausedTime = state.countdownSecondsLeft;
    refs.countdownStartPauseBtn.textContent = "Resume"; 
    updateTimerTabIndicators(); saveTimerProgress(); 
}

function stopCountdownTimer() {
    clearInterval(state.countdownTimer); playAlarm(true); 
    const elapsedSeconds = state.countdownOriginalDuration - state.countdownSecondsLeft;
    if (elapsedSeconds >= 2) {
        logSession(refs.countdownCourseSelect.value, elapsedSeconds, refs.countdownNotes.value.trim(), new Date(state.countdownStartTime).toISOString());
        updateAllDisplays(); refs.countdownNotes.value = '';
    }
    resetCountdownTimer(); 
    saveData(); 
}

function resetCountdownTimer() {
    clearInterval(state.countdownTimer); 
    playAlarm(true); 
    state.isCountdownRunning = false; state.isCountdownPaused = false; state.countdownSecondsLeft = 0; state.countdownStartTime = null;
    
    refs.countdownTimerDisplay.textContent = "00:00:00";
    const savedCountdown = JSON.parse(localStorage.getItem('countdownValues'));
    if (savedCountdown) { refs.countdownHours.value = savedCountdown.h; refs.countdownMinutes.value = savedCountdown.m; refs.countdownSeconds.value = savedCountdown.s; }
    refs.countdownStartPauseBtn.textContent = "Start";
    
    // HIDE BUTTONS (Back to default)
    refs.countdownStopBtn.classList.add('hidden');
    refs.countdownResetBtn.classList.add('hidden');
    refs.countdownStopBtn.disabled = true; 
    refs.countdownResetBtn.disabled = true;
    
    updateTimerTabIndicators();
}

function setTimerMode(mode) {
    refs.stopwatchPanel.classList.add('hidden'); 
    refs.pomodoroPanel.classList.add('hidden'); 
    refs.countdownPanel.classList.add('hidden');
    refs.btnTimerStopwatch.classList.remove('active'); 
    refs.btnTimerPomodoro.classList.remove('active'); 
    refs.btnTimerCountdown.classList.remove('active');
    
    if (mode === 'pomodoro') { refs.pomodoroPanel.classList.remove('hidden'); refs.btnTimerPomodoro.classList.add('active'); } 
    else if (mode === 'countdown') { refs.countdownPanel.classList.remove('hidden'); refs.btnTimerCountdown.classList.add('active'); } 
    else { refs.stopwatchPanel.classList.remove('hidden'); refs.btnTimerStopwatch.classList.add('active'); }
}

function formatTime(sec) { 
    const h=Math.floor(sec/3600).toString().padStart(2,'0'); const m=Math.floor((sec%3600)/60).toString().padStart(2,'0'); const s=(sec%60).toString().padStart(2,'0'); 
    return `${h}:${m}:${s}`; 
}

function formatCountdown(sec) {
    const m=Math.floor(sec / 60).toString().padStart(2, '0'); const s=(sec % 60).toString().padStart(2, '0'); 
    return `${m}:${s}`;
}

module.exports = {
    init, startTimer, pauseTimer, stopTimer, resetStopwatch,
    beginNewPomodoroPhase, startPomodoroCountdown, togglePomodoroPause, stopPomodoro,
    resetPomodoro, skipPomodoroPhase, updatePomodoroDisplay,
    startCountdownTimer, pauseCountdownTimer, stopCountdownTimer, resetCountdownTimer,
    setTimerMode
};
</file>

<file path="js/tools.js">
let audioCtx;
let activeSource = null;
let activeGain = null;
let isPlaying = false;
let currentType = null;

// --- AUDIO ENGINE ---
function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
}

function createNoiseBuffer(type) {
    if (!audioCtx) return null;
    const bufferSize = audioCtx.sampleRate * 2; // 2 seconds buffer
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const output = buffer.getChannelData(0);

    for (let i = 0; i < bufferSize; i++) {
        const white = Math.random() * 2 - 1;
        
        if (type === 'white') {
            output[i] = white;
        } else if (type === 'pink') {
            let b0=0, b1=0, b2=0, b3=0, b4=0, b5=0, b6=0;
            b0 = 0.99886 * b0 + white * 0.0555179;
            b1 = 0.99332 * b1 + white * 0.0750759;
            b2 = 0.96900 * b2 + white * 0.1538520;
            b3 = 0.86650 * b3 + white * 0.3104856;
            b4 = 0.55000 * b4 + white * 0.5329522;
            b5 = -0.7616 * b5 - white * 0.0168980;
            output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
            b6 = white * 0.115926;
            output[i] *= 0.11; 
        } else if (type === 'brown') {
            let lastOut = 0;
            output[i] = (lastOut + (0.02 * white)) / 1.02;
            lastOut = output[i];
            output[i] *= 3.5; 
        }
    }
    return buffer;
}

function toggleNoise(type, volumeEl) {
    initAudio();
    if (audioCtx.state === 'suspended') audioCtx.resume();

    // If clicking same button, toggle off
    if (isPlaying && currentType === type) {
        stopNoise();
        return false;
    }

    if (isPlaying) {
        stopNoise();
    }

    activeSource = audioCtx.createBufferSource();
    activeSource.buffer = createNoiseBuffer(type);
    if (!activeSource.buffer) return false;

    activeSource.loop = true;
    
    activeGain = audioCtx.createGain();
    activeGain.gain.value = parseFloat(volumeEl.value);
    
    activeSource.connect(activeGain);
    activeGain.connect(audioCtx.destination);
    activeSource.start();
    
    isPlaying = true;
    currentType = type;
    return true;
}

function stopNoise() {
    if (activeSource) {
        try { activeSource.stop(); activeSource.disconnect(); } catch (e) {}
    }
    if (activeGain) {
        try { activeGain.disconnect(); } catch (e) {}
    }
    activeSource = null;
    activeGain = null;
    isPlaying = false;
    currentType = null;
}

function setVolume(val) {
    if (activeGain) {
        activeGain.gain.value = val;
    }
}

/// --- BREATHING PACER LOGIC ---
let breathingInterval;
let currentVisualMode = 'orb'; // 'orb' or 'lotus'
let breathStartTime = 0; 

function generateLotus(container) {
    container.innerHTML = '<div class="orb-layer orb-core"></div>'; 
    for(let i = 0; i < 8; i++) {
        const petal = document.createElement('div');
        petal.className = 'lotus-petal';
        petal.style.setProperty('--r', (i * 45) + 'deg'); 
        container.appendChild(petal);
    }
}

function generateOrb(container) {
    container.innerHTML = `
        <div class="orb-layer orb-glow"></div>
        <div class="orb-layer orb-ring"></div>
        <div class="orb-layer orb-core"></div>
    `;
}

function toggleVisualMode(visualContainer, btn) {
    if (currentVisualMode === 'orb') {
        currentVisualMode = 'lotus';
        document.getElementById('breathing-card-container').classList.add('style-lotus');
        generateLotus(visualContainer);
        btn.textContent = "Style: Lotus";
    } else {
        currentVisualMode = 'orb';
        document.getElementById('breathing-card-container').classList.remove('style-lotus');
        generateOrb(visualContainer);
        btn.textContent = "Style: Orb";
    }

    if (breathingInterval) {
        const elapsed = Date.now() - breathStartTime;
        const cycleDuration = 16000; 
        const currentOffset = elapsed % cycleDuration;
        const animatedElements = visualContainer.querySelectorAll('.orb-layer, .lotus-petal');
        animatedElements.forEach(el => {
            el.style.animationDelay = `-${currentOffset}ms`;
        });
    }
}

function toggleBreathing(container, label) {
    const body = document.body;
    
    if (breathingInterval) {
        // Stop
        clearInterval(breathingInterval);
        breathingInterval = null;
        container.classList.remove('breathing-active');
        body.classList.remove('breathing-mode'); 
        label.textContent = "Tap to Center";
        label.style.opacity = "0.8";
    } else {
        // Start
        container.classList.add('breathing-active');
        body.classList.add('breathing-mode'); 
        
        // --- FIX: Force Reset Animation Alignment ---
        const animatedElements = document.querySelectorAll('.orb-layer, .lotus-petal');
        animatedElements.forEach(el => el.style.animationDelay = '0s');
        // --------------------------------------------

        breathStartTime = Date.now(); 
        
        const updateText = () => {
            const cycleTime = 16000; 
            const elapsed = (Date.now() - breathStartTime) % cycleTime; 
            
            if (elapsed < 4000) {
                label.textContent = "Inhale...";
                label.style.opacity = "1";
            } else if (elapsed < 8000) {
                label.textContent = "Hold (Full)";
                label.style.opacity = "0.7";
            } else if (elapsed < 12000) {
                label.textContent = "Exhale...";
                label.style.opacity = "0.5";
            } else {
                label.textContent = "Hold (Empty)";
                label.style.opacity = "0.7";
            }
        };

        updateText(); 
        breathingInterval = setInterval(updateText, 100);
    }
}

function initToolsListeners() {
    const btnBrown = document.getElementById('noise-brown');
    const btnPink = document.getElementById('noise-pink');
    const btnWhite = document.getElementById('noise-white');
    const btnStop = document.getElementById('noise-stop');
    const volSlider = document.getElementById('noise-volume');
    
    const updateBtns = () => {
        if(btnBrown) btnBrown.classList.toggle('active', currentType === 'brown');
        if(btnPink) btnPink.classList.toggle('active', currentType === 'pink');
        if(btnWhite) btnWhite.classList.toggle('active', currentType === 'white');
    };

    const handleNoiseClick = (type) => { toggleNoise(type, volSlider); updateBtns(); };
    
    if(btnBrown) btnBrown.addEventListener('click', () => handleNoiseClick('brown'));
    if(btnPink) btnPink.addEventListener('click', () => handleNoiseClick('pink'));
    if(btnWhite) btnWhite.addEventListener('click', () => handleNoiseClick('white'));
    if(btnStop) btnStop.addEventListener('click', () => { stopNoise(); updateBtns(); });
    if(volSlider) volSlider.addEventListener('input', (e) => setVolume(e.target.value));

    const breathTrigger = document.getElementById('breathing-trigger');
    const breathLabel = document.getElementById('breathing-label');
    const visualContainer = document.getElementById('visual-container');
    const styleBtn = document.getElementById('btn-style-toggle');
    
    if(breathTrigger && breathLabel) {
        breathTrigger.addEventListener('click', () => toggleBreathing(breathTrigger, breathLabel));
    }

    if(styleBtn && visualContainer) {
        styleBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            toggleVisualMode(visualContainer, styleBtn);
        });
    }
}

module.exports = { initToolsListeners };
</file>

<file path="js/uiRefs.js">
const refs = {
    courseSelect: document.getElementById('courseSelect'), 
    timerDisplay: document.getElementById('timerDisplay'), 
    startButton: document.getElementById('startButton'), 
    stopButton: document.getElementById('stopButton'), 
    resetButton: document.getElementById('resetButton'),
    sessionNotes: document.getElementById('sessionNotes'), 
    sessionLog: document.getElementById('sessionLog'), 
    showAllButton: document.getElementById('showAllButton'), 
    scoreCourseSelect: document.getElementById('scoreCourseSelect'), 
    scoreInput: document.getElementById('scoreInput'), 
    scoreNotes: document.getElementById('scoreNotes'), 
    logScoreButton: document.getElementById('logScoreButton'), 
    streakContainer: document.getElementById('streak-container'), 
    streakCount: document.getElementById('streak-count'),
    
    taskList: document.getElementById('task-list'),
    btnToggleTasks: document.getElementById('btn-toggle-tasks'),
    
    btnCalendarToday: document.getElementById('btn-calendar-today'),

    eventModal: document.getElementById('event-modal'), 
    modalTitle: document.getElementById('modal-title'), 
    eventText: document.getElementById('event-text'), 
    saveEventButton: document.getElementById('save-event-button'), 
    cancelEventButton: document.getElementById('cancel-event-button'),
    eventTimestamp: document.getElementById('event-timestamp'),
    eventError: document.getElementById('eventError'),
    eventDatePicker: document.getElementById('event-date-picker'),
    
    timerError: document.getElementById('timerError'),
    scoreError: document.getElementById('scoreError'),
    pomodoroError: document.getElementById('pomodoroError'),
    
    confirmModal: document.getElementById('confirm-modal'),
    itemToProcess: document.getElementById('item-to-process'), 
    confirmDeleteButton: document.getElementById('confirm-delete-button'),
    cancelDeleteButton: document.getElementById('cancel-delete-button'),
    modalConfirmTitle: document.getElementById('modal-confirm-title'),
    modalConfirmText: document.getElementById('modal-confirm-text'),

    pomodoroPromptModal: document.getElementById('pomodoro-prompt-modal'),
    pomodoroPromptTitle: document.getElementById('pomodoro-prompt-title'),
    pomodoroPromptText: document.getElementById('pomodoro-prompt-text'),
    pomodoroPromptConfirmBtn: document.getElementById('pomodoro-prompt-confirm-btn'),
    pomodoroPromptStopBtn: document.getElementById('pomodoro-prompt-stop-btn'),

    editModal: document.getElementById('edit-log-modal'),
    editTimestamp: document.getElementById('edit-timestamp'),
    editDatePicker: document.getElementById('edit-date-picker'), 
    editCourseSelect: document.getElementById('edit-course-select'),
    editSessionGroup: document.getElementById('edit-session-group'),
    editDuration: document.getElementById('edit-duration'),
    editScoreGroup: document.getElementById('edit-score-group'),
    editScore: document.getElementById('edit-score'),
    editNotes: document.getElementById('edit-notes'),
    editError: document.getElementById('editError'),
    saveEditButton: document.getElementById('save-edit-button'),
    cancelEditButton: document.getElementById('cancel-edit-button'),

    chartModal: document.getElementById('chart-modal'),
    zoomedChartTitle: document.getElementById('zoomed-chart-title'),
    zoomedChartContainer: document.getElementById('zoomed-chart-container'),
    closeChartModalButton: document.getElementById('close-chart-modal-button'),

    btnPieTotal: document.getElementById('btn-pie-total'),
    btnPieToday: document.getElementById('btn-pie-today'),
    btnPieTrend: document.getElementById('btn-pie-trend'), 
    trendSpanSelect: document.getElementById('trend-span-select'), 

    coursesModal: document.getElementById('courses-modal'),
    newCourseName: document.getElementById('new-course-name'),
    addCourseBtn: document.getElementById('add-course-btn'),
    courseListEditor: document.getElementById('course-list-editor'),
    closeCoursesModalBtn: document.getElementById('close-courses-modal-btn'),

    globalSettingsBtn: document.getElementById('global-settings-btn'),
    manageCoursesFromSettingsBtn: document.getElementById('manage-courses-from-settings-btn'),
    settingsModal: document.getElementById('settings-modal'),
    closeSettingsModalBtn: document.getElementById('close-settings-modal-btn'),
    alarmSoundInput: document.getElementById('alarm-sound-input'),
    testAlarmBtn: document.getElementById('test-alarm-btn'),
    saveSettingsBtn: document.getElementById('save-settings-btn'), 
    alarmSound: document.getElementById('alarm-sound'),
    selectAlarmBtn: document.getElementById('select-alarm-btn'),
    selectedAlarmFile: document.getElementById('selected-alarm-file'),
    
    streakTargetInput: document.getElementById('streak-target-input'),
    streakMinTimeInput: document.getElementById('streak-min-time-input'), 
    deadlineUrgencyInput: document.getElementById('deadline-urgency-input'), 
    
    settingFocusDuration: document.getElementById('setting-focus-duration'),
    settingShortBreakDuration: document.getElementById('setting-short-break-duration'),
    settingLongBreakDuration: document.getElementById('setting-long-break-duration'),

    exportDataBtn: document.getElementById('export-data-btn'),
    importDataBtn: document.getElementById('import-data-btn'),
    importFileInput: document.getElementById('import-file-input'),

    btnTimerStopwatch: document.getElementById('btn-timer-stopwatch'),
    btnTimerPomodoro: document.getElementById('btn-timer-pomodoro'),
    btnTimerCountdown: document.getElementById('btn-timer-countdown'),
    btnFocusMode: document.getElementById('btn-focus-mode'), 
    stopwatchPanel: document.getElementById('stopwatch-panel'),
    pomodoroPanel: document.getElementById('pomodoro-panel'),
    countdownPanel: document.getElementById('countdown-panel'),

    pomodoroCourseSelect: document.getElementById('pomodoroCourseSelect'),
    pomodoroTimerDisplay: document.getElementById('pomodoroTimerDisplay'),
    pomodoroStatus: document.getElementById('pomodoro-status'),
    
    pomodoroStartBtn: document.getElementById('pomodoro-start-btn'),
    
    pomodoroPauseResumeBtn: document.getElementById('pomodoro-pause-resume-btn'),
    pomodoroStopBtn: document.getElementById('pomodoro-stop-btn'),
    pomodoroResetBtn: document.getElementById('pomodoro-reset-btn'),
    pomodoroSkipBtn: document.getElementById('pomodoro-skip-btn'),

    pomodoroNotes: document.getElementById('pomodoroNotes'),
    pomodoroStartControls: document.getElementById('pomodoro-start-controls'),
    pomodoroRunningControls: document.getElementById('pomodoro-running-controls'),

    countdownTimerDisplay: document.getElementById('countdownTimerDisplay'),
    countdownHours: document.getElementById('countdown-hours'),
    countdownMinutes: document.getElementById('countdown-minutes'),
    countdownSeconds: document.getElementById('countdown-seconds'),
    countdownStartPauseBtn: document.getElementById('countdown-start-pause-btn'),
    countdownStopBtn: document.getElementById('countdown-stop-btn'),
    countdownResetBtn: document.getElementById('countdown-reset-btn'),
    countdownCourseSelect: document.getElementById('countdownCourseSelect'),
    countdownNotes: document.getElementById('countdownNotes'),

    btnLogChrono: document.getElementById('btn-log-chrono'),
    btnLogTopic: document.getElementById('btn-log-topic'),

    studyCalendar: document.getElementById('study-calendar'),
    timeChart: document.getElementById('time-chart'),
    scoreChart: document.getElementById('score-chart')
};
module.exports = refs;
</file>

<file path="main.js">
const { app, BrowserWindow, ipcMain, dialog } = require('electron');
const path = require('path');
const fs = require('fs');
const { autoUpdater } = require('electron-updater');
const log = require('electron-log');

// Handle creating/removing shortcuts on Windows when installing/uninstalling.
if (require('electron-squirrel-startup')) {
  app.quit();
}

// 1. Configure Logging
log.transports.file.level = 'info';
autoUpdater.logger = log;

// 2. Data Migration Logic
function checkAndMigrateData() {
    const userDataPath = app.getPath('userData'); // 'medchronos'
    const appDataPath = app.getPath('appData');
    
    // Check old folder names in order of priority
    const oldAppNames = ['pre-prep-hub', 'residency-prep-hub', 'MedChronus'];
    const localStoragePath = path.join(userDataPath, 'Local Storage');

    if (fs.existsSync(localStoragePath)) {
        log.info("Data exists in MedChronos. No migration needed.");
        return;
    }

    log.info("Checking for old data to migrate...");

    for (const oldName of oldAppNames) {
        const oldPath = path.join(appDataPath, oldName);
        if (fs.existsSync(oldPath)) {
            log.info(`Migrating data from: ${oldPath}`);
            try {
                fs.cpSync(oldPath, userDataPath, { recursive: true, force: true });
                log.info("Migration successful.");
                break; 
            } catch (err) {
                log.error("Migration failed:", err);
            }
        }
    }
}

// 3. Auto-Updater Logic
function setupAutoUpdater(window) {
  autoUpdater.checkForUpdatesAndNotify();

  autoUpdater.on('update-available', () => {
    window.webContents.send('update-message', 'Update available. Downloading...');
  });

  autoUpdater.on('update-downloaded', () => {
    const response = dialog.showMessageBoxSync(window, {
      type: 'info',
      buttons: ['Restart and Install', 'Later'],
      title: 'Update Ready',
      message: 'A new version has been downloaded.',
      detail: 'Restart the application to apply the update?'
    });

    if (response === 0) {
      autoUpdater.quitAndInstall();
    }
  });
}

// 4. Main Window Logic
app.commandLine.appendSwitch('force-device-scale-factor', '0.9');

async function handleFileOpen() {
    const { canceled, filePaths } = await dialog.showOpenDialog({
        properties: ['openFile'],
        filters: [{ name: 'Audio Files', extensions: ['mp3', 'wav', 'ogg'] }]
    });
    if (!canceled) return filePaths[0];
}

function createWindow() {
  const mainWindow = new BrowserWindow({
    width: 1720, height: 1300, minWidth: 800, minHeight: 600,
    icon: path.join(__dirname, 'icon.ico'),
    show: false,
    backgroundColor: '#f4f7f9',
    webPreferences: { nodeIntegration: true, contextIsolation: false },
    title: `MedChronos v${app.getVersion()}`
  });

  mainWindow.loadFile('index.html');

  mainWindow.once('ready-to-show', () => {
    mainWindow.show();
    setupAutoUpdater(mainWindow);
  });
}

app.whenReady().then(() => {
    checkAndMigrateData();
    ipcMain.handle('dialog:openFile', handleFileOpen);
    createWindow();
});

app.on('window-all-closed', () => { if (process.platform !== 'darwin') app.quit(); });
app.on('activate', () => { if (BrowserWindow.getAllWindows().length === 0) createWindow(); });
</file>

<file path="package.json">
{
  "name": "medchronos",
  "version": "1.0.3",
  "description": "A study tracker for medical exams.",
  "main": "main.js",
  "repository": {
    "type": "git",
    "url": "https://github.com/crocodilusniloticus/residency-prep-hub.git"
  },
  "scripts": {
    "start": "electron-forge start",
    "package": "electron-forge package",
    "make": "electron-forge make",
    "publish": "electron-forge publish"
  },
  "author": "ASh",
  "license": "ISC",
  "config": {
    "forge": {
      "packagerConfig": {
        "icon": "./icon",
        "executableName": "MedChronos"
      },
      "makers": [
        {
          "name": "@electron-forge/maker-squirrel",
          "config": {
            "setupIcon": "./icon.ico",
            "setupExe": "MedChronosSetup.exe"
          }
        },
        {
          "name": "@electron-forge/maker-zip",
          "platforms": ["darwin"]
        },
        {
          "name": "@electron-forge/maker-deb",
          "config": { "options": { "icon": "./icon.png" } }
        },
        {
          "name": "@electron-forge/maker-rpm",
          "config": {}
        }
      ],
      "publishers": [
        {
          "name": "@electron-forge/publisher-github",
          "config": {
            "repository": {
              "owner": "crocodilusniloticus",
              "name": "residency-prep-hub"
            },
            "prerelease": false,
            "draft": true
          }
        }
      ]
    }
  },
  "dependencies": {
    "@popperjs/core": "^2.11.8",
    "echarts": "^6.0.0",
    "electron-log": "^5.0.0",
    "electron-squirrel-startup": "^1.0.1",
    "electron-updater": "^6.1.0",
    "flatpickr": "^4.6.13",
    "flatpickr-jalali-support": "^1.0.3",
    "jdate": "^0.0.2",
    "luxon": "^3.7.2",
    "matplotlib": "^1.0.0",
    "tippy.js": "^6.3.7"
  },
  "devDependencies": {
    "@electron-forge/cli": "^7.10.2",
    "@electron-forge/maker-deb": "^7.10.2",
    "@electron-forge/maker-rpm": "^7.10.2",
    "@electron-forge/maker-squirrel": "^7.10.2",
    "@electron-forge/maker-zip": "^7.10.2",
    "@electron-forge/plugin-auto-unpack-natives": "^7.10.2",
    "@electron-forge/plugin-fuses": "^7.10.2",
    "@electron-forge/publisher-github": "^7.10.2",
    "@electron/fuses": "^1.8.0",
    "electron": "^28.0.0",
    "electron-builder": "^26.0.12",
    "electron-reloader": "^1.2.3"
  }
}
</file>

<file path="renderer.js">
const { ipcRenderer } = require('electron');

window.ipcRenderer = ipcRenderer;

// --- CRITICAL FIX: Load Standard Flatpickr Only ---
try {
    // 1. Load the standard, stable calendar engine
    window.flatpickr = require('flatpickr'); 
    
    // 2. Load your custom Persian labels (the ones we fixed in js/fa.js)
    require('./js/fa.js'); 
    
    // 3. Load JDate for the math (needed for the visual conversion)
    window.JDate = require('jdate');

} catch (e) {
    console.error("CRITICAL: Failed to load dependencies.", e);
}
// --------------------------------------------------

window.echarts = require('echarts');
const { createPopper } = require('@popperjs/core');
const tippy = require('tippy.js').default; 
window.tippy = tippy;

function initializeApp() {
    if (window.isAppInitialized) {
        return;
    }

    const preFlightCheck = () => {
        const errors = [];
        if (!window.flatpickr) errors.push('Calendar library failed to load. Did you run "npm install"?');
        if (!window.echarts) errors.push('ECharts failed to load.');
        
        if (errors.length > 0) {
            throw new Error('Startup Failed:\n' + errors.join('\n'));
        }
    };

    try {
        preFlightCheck(); 

        const state = require('./js/state');
        const refs = require('./js/uiRefs');
        const dataManager = require('./js/dataManager');
        const charts = require('./js/charts');
        const timers = require('./js/timers');
        const modals = require('./js/modals');
        const views = require('./js/views');
        const listeners = require('./js/listeners');
        const tools = require('./js/tools'); 

        const updateAllDisplays = () => {
            views.populateCourses(); 
            views.updateLogDisplay(); 
            views.updateCalendar(); 
            charts.updateTimeChart(); 
            charts.updateScoreChart(); 
            views.updateTaskDashboard(); 
            views.updateCourseEditorList();
            if(timers && timers.updatePomodoroDisplay) timers.updatePomodoroDisplay();
        };

        dataManager.init(state, refs);
        charts.init(state, refs); 
        charts.initializeCharts(); 
        charts.setPieMode(state.pieChartMode);

        timers.init(state, refs, dataManager.logSession, modals.playAlarm, updateAllDisplays, dataManager.saveData, dataManager.saveTimerProgress);
        views.init(state, refs, modals.showEventModal, dataManager.logSession);
        modals.init(state, refs, dataManager, updateAllDisplays, charts.getTimeChartOptions, charts.getScoreChartOptions, charts.getCharts, charts.getTrendChartOptions);
        
        listeners.init(state, refs, timers, modals, charts, views, dataManager, updateAllDisplays);       
        tools.initToolsListeners(); 

        dataManager.loadData();
        dataManager.checkForRecoveredSession();
        views.populateCourses();
        views.initializeCalendar();
        views.initializeEventModalPicker();
        views.initializeGlobalTooltips();
        
        updateAllDisplays(); 
        
        window.isAppInitialized = true;

        setTimeout(() => {
            if (charts.getCharts().timeChart) charts.getCharts().timeChart.resize();
            if (charts.getCharts().scoreChart) charts.getCharts().scoreChart.resize();
        }, 50);

    } catch (error) {
        document.body.innerHTML = `
            <div style="padding: 20px; font-family: sans-serif; background: #fff1f2; color: #9f1239; height: 100vh; text-align: center;">
                <h2>Startup Error</h2>
                <p>Could not initialize the app.</p>
                <pre style="background: #333; color: #fff; padding: 15px; text-align: left;">${error.stack}</pre>
            </div>
        `;
        console.error(error);
    }
}

document.addEventListener('DOMContentLoaded', initializeApp);
</file>

<file path="index.html">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Security Policy allows local scripts and styles -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data:; media-src 'self' file:;">
    <title>MedChronos</title>
    
    <!-- CSS Dependencies -->
    <!-- 1. Standard Flatpickr Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- 2. Airbnb Theme (cleaner look) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
    <!-- 3. Your App Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- CSS Override for Persian Direction -->
    <style>
        .flatpickr-calendar { font-family: 'Inter', sans-serif; direction: rtl; }
        .flatpickr-month { direction: ltr; } /* Keeps arrows correct */
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <header class="app-header">
            <div class="header-brand">
                <div class="logo-icon">âš•ï¸</div>
                <h1>Med<strong>Chronos</strong></h1>
            </div>
            <div class="header-stats">
                <div id="streak-container" class="streak-badge" data-tooltip="Current Study Streak">
                    <span class="streak-icon">ğŸ”¥</span>
                    <div class="streak-info">
                        <span id="streak-count">0</span>
                        <span class="streak-label">Day Streak</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button id="global-settings-btn" class="icon-btn" aria-label="Settings" data-tooltip="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </header>

        <!-- MAIN GRID -->
        <div class="dashboard-grid">
            
            <!-- 1. STUDY CARD -->
            <section class="card study-card">
                <div class="card-header">
                    <h3>Study Trend</h3>
                    <div class="chart-controls-group">
                        <div class="toggle-pill-container">
                            <button id="btn-pie-trend" class="toggle-pill active" style="width: 70px;">Trend</button>
                            <button id="btn-pie-total" class="toggle-pill" style="width: 70px;">Total</button>
                            <button id="btn-pie-today" class="toggle-pill" style="width: 70px;">Today</button>
                        </div>
                        <select id="trend-span-select" class="trend-select">
                            <option value="7">7 Days</option>
                            <option value="30">30 Days</option>
                        </select>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-header-row">
                        <div id="trend-stats-container" class="trend-stats-box">
                            <span id="trend-stats-value" class="stat-value">--</span>
                            <span id="trend-stats-status" class="stat-status"></span>
                        </div>
                    </div>
                    <div class="chart-content-area" style="position: relative; flex-grow: 1; width: 100%; min-height: 0;">
                        <div class="chart-container chart-clickable" id="time-chart" style="width: 100%; height: 100%;"></div>
                        <div id="pie-overlay" class="pie-center-text hidden">
                            <div id="pie-val" class="pie-val-text">0.0</div>
                            <div class="pie-label-text">HOURS</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. PERFORMANCE CARD -->
            <section class="card performance-card">
                <div class="card-header">
                    <h3>Performance</h3>
                    <div class="chart-controls-group"></div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-header-row"></div>
                    <div class="chart-container chart-clickable" id="score-chart"></div>
                </div>
            </section>

            <!-- 3. TASKS CARD -->
            <section class="card tasks-card">
                <div class="card-header">
                    <h3>Deadlines</h3>
                    <button id="btn-toggle-tasks" class="text-link-btn">Show Completed</button>
                </div>
                <div id="task-list" class="custom-scrollbar"></div>
            </section>

            <!-- 4. LEFT STACK -->
            <div class="left-stack">
                <section class="card calendar-card">
                    <div class="card-header compact-header">
                        <h3>Calendar</h3>
                        <button id="btn-calendar-today" class="text-link-btn">Today</button>
                    </div>
                    <div id="study-calendar"></div>
                </section>

                <section class="card score-card">
                    <div class="card-header compact-header"><h3>Log Score</h3></div>
                    <div class="score-grid">
                        <select id="scoreCourseSelect" class="modern-select"></select>
                        <input type="number" id="scoreInput" class="modern-input" min="0" max="100" placeholder="%">
                        <button id="logScoreButton" class="btn btn-primary">Log</button>
                    </div>
                    <textarea id="scoreNotes" class="modern-textarea" placeholder="Exam notes..." rows="1"></textarea>
                    <div id="scoreError" class="error-message"></div>
                </section>
            </div>

            <!-- 5. TIMER CARD -->
            <section class="card timer-card">
                <div class="card-header">
                    <h3>Active Session</h3>
                    <button id="btn-focus-mode" class="icon-btn focus-btn" data-tooltip="Enter Focus Mode">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                </div>
                <div class="timer-mode-switcher">
                    <button id="btn-timer-stopwatch" class="mode-tab active">Stopwatch</button>
                    <button id="btn-timer-pomodoro" class="mode-tab">Pomodoro</button>
                    <button id="btn-timer-countdown" class="mode-tab">Countdown</button>
                </div>
                <div class="timer-body">
                    <!-- Stopwatch -->
                    <div id="stopwatch-panel" class="timer-panel">
                        <div class="input-group"><select id="courseSelect" class="modern-select large-text"></select></div>
                        <div class="timer-display-container"><div id="timerDisplay" class="main-timer-text">00:00:00</div></div>
                        <div class="timer-actions">
                            <button id="startButton" class="btn btn-primary btn-large">Start Session</button>
                            <button id="stopButton" class="btn btn-danger hidden" disabled>Stop</button>
                            <button id="resetButton" class="btn btn-ghost hidden" disabled>Reset</button> 
                        </div>
                        <div id="timerError" class="error-message"></div>
                        <textarea id="sessionNotes" class="modern-textarea" placeholder="Session notes..."></textarea>
                    </div>
                    
                    <!-- Pomodoro -->
                    <div id="pomodoro-panel" class="timer-panel hidden">
                        <div class="input-group"><select id="pomodoroCourseSelect" class="modern-select large-text"></select></div>
                        <div class="timer-display-container">
                            <div id="pomodoroTimerDisplay" class="main-timer-text">50:00</div>
                            <div id="pomodoro-status" class="status-badge"></div>
                        </div>
                        <div id="pomodoro-start-controls" class="timer-actions">
                            <button id="pomodoro-start-btn" class="btn btn-primary btn-large">Start Focus</button>
                        </div>
                        <div id="pomodoro-running-controls" class="timer-actions hidden">
                            <button id="pomodoro-pause-resume-btn" class="btn btn-primary">Pause</button>
                            <button id="pomodoro-stop-btn" class="btn btn-danger">Stop</button>
                            <button id="pomodoro-reset-btn" class="btn btn-outline">Reset</button> 
                            <button id="pomodoro-skip-btn" class="btn btn-outline" data-tooltip="Skip current phase">Skip</button>
                        </div>
                        <div id="pomodoroError" class="error-message"></div>
                        <textarea id="pomodoroNotes" class="modern-textarea" placeholder="Session notes..."></textarea>
                    </div>

                    <!-- Countdown -->
                    <div id="countdown-panel" class="timer-panel hidden">
                        <div class="input-group"><select id="countdownCourseSelect" class="modern-select large-text"></select></div>
                        <div class="timer-display-container"><div id="countdownTimerDisplay" class="main-timer-text">00:00:00</div></div>
                        <div class="countdown-inputs-row">
                            <div class="time-input-wrapper"><input type="number" id="countdown-hours" min="0" max="23" placeholder="00"><label>HR</label></div>
                            <div class="time-input-wrapper"><input type="number" id="countdown-minutes" min="0" max="59" placeholder="00"><label>MIN</label></div>
                            <div class="time-input-wrapper"><input type="number" id="countdown-seconds" min="0" max="59" placeholder="00"><label>SEC</label></div>
                        </div>
                        <div class="timer-actions">
                            <button id="countdown-start-pause-btn" class="btn btn-primary btn-large">Start</button>
                            <button id="countdown-stop-btn" class="btn btn-danger hidden" disabled>Stop</button>
                            <button id="countdown-reset-btn" class="btn btn-ghost hidden" disabled>Reset</button>
                        </div>
                        <div id="countdownError" class="error-message"></div>
                        <textarea id="countdownNotes" class="modern-textarea" placeholder="Session notes..."></textarea>
                    </div>
                </div>
            </section>

            <!-- 6. TOOLS STACK -->
            <div class="tools-stack">
                <section class="card sound-card">
                    <div class="card-header compact-header" style="width:100%; position: absolute; top: 15px; left: 0; padding: 0 20px;">
                        <h3>Focus Audio</h3>
                    </div>
                    <div class="sound-controls">
                        <div class="sound-btn-row">
                            <button id="noise-brown" class="sound-btn" data-tooltip="Deep Focus (Brown Noise)">ğŸŒŠ</button>
                            <button id="noise-pink" class="sound-btn" data-tooltip="Soft Focus (Pink Noise)">ğŸŒ§ï¸</button>
                            <button id="noise-white" class="sound-btn" data-tooltip="Blocker (White Noise)">ğŸ“¡</button>
                            <button id="noise-stop" class="sound-stop-btn" data-tooltip="Stop Audio">â¹</button>
                        </div>
                        <div class="volume-slider-container">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                            <input type="range" id="noise-volume" class="volume-slider" min="0" max="1" step="0.01" value="0.5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                        </div>
                    </div>
                </section>

                <section class="card breathing-card" id="breathing-card-container">
                    <div class="card-header compact-header" style="width:100%; position: absolute; top: 15px; left: 0; padding: 0 20px;">
                        <h3>Box Breathing</h3>
                    </div>
                    <div class="breathing-circle-container" id="breathing-trigger">
                        <div id="visual-container">
                            <div class="orb-layer orb-glow"></div>
                            <div class="orb-layer orb-ring"></div>
                            <div class="orb-layer orb-core"></div>
                        </div>
                    </div>
                    <div id="breathing-label" class="breathing-text">Tap to Center</div>
                    <div class="breathing-footer">
                        <button id="btn-style-toggle" class="style-toggle-btn">Style: Orb</button>
                    </div>
                </section>
            </div>

            <!-- 7. LOG CARD -->
            <section class="card log-card">
                <div class="card-header">
                    <h3>History</h3>
                    <div class="header-tools">
                        <div class="toggle-pill-container small">
                            <button id="btn-log-chrono" class="toggle-pill active">Time</button>
                            <button id="btn-log-topic" class="toggle-pill">Topic</button>
                        </div>
                        <button id="showAllButton" class="text-link-btn" hidden>Clear Filter</button>
                    </div>
                </div>
                <div id="sessionLog" class="log-list custom-scrollbar"></div>
            </section>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Event/Deadline Modal -->
    <div id="event-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">Add Deadline</h2>
            <div class="input-group">
                <label>Title</label>
                <input type="text" id="event-text" class="modern-input" placeholder="e.g. Nephro Exam">
            </div>
            <div class="input-group">
                <label>Due Date</label>
                <input type="text" id="event-date-picker" class="modern-input" placeholder="Required">
            </div>
            <input type="hidden" id="event-timestamp">
            <div id="eventError" class="error-message"></div>
            <div class="modal-footer">
                <button id="cancel-event-button" class="btn btn-ghost">Cancel</button>
                <button id="save-event-button" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Settings</h2>
            <div class="settings-section" style="margin-bottom:15px;">
                <button id="manage-courses-from-settings-btn" class="btn btn-outline" style="width:100%">Manage Courses</button>
            </div>
            <div class="settings-section" style="margin-bottom:15px;">
                <label>Alarm</label>
                <div style="display:flex; gap:10px;">
                    <button id="select-alarm-btn" class="btn btn-outline" style="flex:1;">Select File</button>
                    <button id="test-alarm-btn" class="btn btn-ghost">Test</button>
                </div>
                <span id="selected-alarm-file" style="font-size:0.8rem; color:var(--text-muted); display:block; margin-top:5px;">Default</span>
                <input type="hidden" id="alarm-sound-input">
            </div>
            <div class="settings-section form-grid">
                <div class="input-group"><label>Streak Goal (Days)</label><input type="number" id="streak-target-input" class="modern-input"></div>
                <div class="input-group"><label>Min Time (Mins)</label><input type="number" id="streak-min-time-input" class="modern-input"></div>
                <div class="input-group" style="grid-column: 1 / -1;"><label>Deadline Lookahead (Days)</label><input type="number" id="deadline-urgency-input" class="modern-input" min="1" max="365"></div>
            </div>
            <div class="settings-section" style="margin-top:15px; border-top: 1px solid var(--border); padding-top: 15px;">
                <label style="margin-bottom: 8px; display: block; font-weight: 600; color: var(--text-main);">Pomodoro Timings (Mins)</label>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="input-group"><label style="font-size: 0.75rem;">Focus</label><input type="number" id="setting-focus-duration" class="modern-input"></div>
                    <div class="input-group"><label style="font-size: 0.75rem;">Short Brk</label><input type="number" id="setting-short-break-duration" class="modern-input"></div>
                    <div class="input-group"><label style="font-size: 0.75rem;">Long Brk</label><input type="number" id="setting-long-break-duration" class="modern-input"></div>
                </div>
            </div>
            <div class="settings-section" style="margin-top:15px; border-top: 1px solid var(--border); padding-top: 15px;">
                <label>Backup</label>
                <div style="display:flex; gap:10px;">
                    <button id="export-data-btn" class="btn btn-outline" style="flex:1;">Export</button>
                    <button id="import-data-btn" class="btn btn-outline" style="flex:1;">Import</button>
                </div>
                <input type="file" id="import-file-input" style="display:none" accept=".json">
            </div>
            <div class="modal-footer">
                <button id="close-settings-modal-btn" class="btn btn-ghost">Cancel</button>
                <button id="save-settings-btn" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Pomodoro Complete Modal -->
    <div id="pomodoro-prompt-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: center;">
            <h2 id="pomodoro-prompt-title" style="border:none; margin-bottom: 10px;">Phase Complete!</h2>
            <p id="pomodoro-prompt-text" style="color:var(--text-muted); font-size: 1rem; margin-bottom: 25px;"></p>
            <div class="modal-footer" style="justify-content: center; gap: 20px;">
                <button id="pomodoro-prompt-stop-btn" class="btn btn-ghost">Stop Session</button>
                <button id="pomodoro-prompt-confirm-btn" class="btn btn-primary btn-large">Start Next Phase</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-confirm-title">Confirm</h2>
            <p id="modal-confirm-text" style="color:var(--text-muted);"></p>
            <input type="hidden" id="item-to-process">
            <div class="modal-footer">
                <button id="cancel-delete-button" class="btn btn-ghost">Cancel</button>
                <button id="confirm-delete-button" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Log Modal -->
    <div id="edit-log-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="edit-modal-title">Edit Entry</h2>
            <input type="hidden" id="edit-timestamp">
            <div class="form-grid">
                <div class="input-group"><label>Date</label><input type="text" id="edit-date-picker" class="modern-input"></div>
                <div class="input-group"><label>Course</label><select id="edit-course-select" class="modern-select"></select></div>
            </div>
            <div id="edit-session-group" class="input-group"><label>Duration</label><input type="text" id="edit-duration" class="modern-input"></div>
            <div id="edit-score-group" class="input-group"><label>Score</label><input type="number" id="edit-score" class="modern-input"></div>
            <div class="input-group"><label>Notes</label><textarea id="edit-notes" class="modern-textarea" rows="3"></textarea></div>
            <div id="editError" class="error-message"></div>
            <div class="modal-footer">
                <button id="cancel-edit-button" class="btn btn-ghost">Cancel</button>
                <button id="save-edit-button" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Chart Zoom Modal -->
    <div id="chart-modal" class="modal-overlay">
        <div class="modal-content chart-modal-content">
            <h2 id="zoomed-chart-title"></h2>
            <div id="zoomed-chart-container"></div>
            <div class="modal-footer">
                <button id="close-chart-modal-button" class="btn btn-ghost">Close</button>
            </div>
        </div>
    </div>

    <!-- Courses Management Modal -->
    <div id="courses-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Manage Courses</h2>
            <div class="input-group" style="display:flex; gap:10px;">
                <input type="text" id="new-course-name" class="modern-input" placeholder="New Course">
                <button id="add-course-btn" class="btn btn-primary">Add</button>
            </div>
            <hr style="margin:15px 0; border:0; border-top:1px solid var(--border);">
            <div id="course-list-editor" class="course-list-container custom-scrollbar"></div>
            <div class="modal-footer">
                <button id="close-courses-modal-btn" class="btn btn-ghost">Close</button>
            </div>
        </div>
    </div>

    <audio id="alarm-sound"></audio>
    
    <!-- IMPORTANT: Only local script loaded -->
    <script src="./renderer.js"></script>
</body>
</html>
</file>

<file path="styles.css">
:root { 
    /* THE DESK (Background) */
    --bg-body: #4a413a; /* Dark Taupe / Canyon Shadow */
    --text-on-desk: #f2f0e6; /* Bleached Bone */

    /* THE PAGES (Panels) - Muted, Dry, Earthy Neutrals */
    --card-study-bg: #fffaf0;    /* Pure Bone White */
    --card-study-accent: #1e1e1e; /* Deepest Shadow Black */
    
    --card-perf-bg: #fdf8e6;     /* Sun-baked Sand */
    --card-perf-accent: #c68e17; /* Adobe Gold */

    --card-tasks-bg: #f8e8e7;    /* Dusty Rose */
    --card-tasks-accent: #8b3a3a; /* Muted Terracotta */

    --card-cal-bg: #f5f5f5;      /* Chalk White */
    --card-cal-accent: #78909c;  /* Soft Cliff Gray */

    --card-timer-bg: #fffaf0;    /* Bone White */
    --card-timer-accent: #4a413a; /* Dark Taupe */

    --card-tools-bg: #f7f7f7;    /* Light Bleached Stone */
    --card-tools-accent: #546e7a; /* Cool Shadow Blue */

    --card-log-bg: #f2f0e6;      /* Bone/Parchment */
    --card-log-accent: #8d6e63;  /* Dried Earth Brown */

    /* INK (Text) */
    --text-main: #4a413a;    /* Dark Taupe Ink */
    --text-muted: #9e9e9e;   /* Faded Stone Gray */

    /* Functional Colors */
    --primary: #8b3a3a;      /* Muted Terracotta (Focus) */
    --primary-hover: #7b2c2c;
    --primary-light: #f8e8e7; 
    
    --success: #66bb6a;      /* Desert Bloom Green */
    --success-bg: #e8f5e9;    
    
    --danger: #cd5c5c;       /* Soft Brick Red */
    --danger-bg: #f8e8e7;     
    
    --warning: #c68e17;      /* Adobe Gold */
    --warning-bg: #fdf8e6;      

    /* Spacing & Shadow */
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
    --shadow-md: 0 5px 10px rgba(0,0,0,0.2);
    --shadow-lg: 0 8px 20px rgba(0, 0, 0, 0.3);
    --radius: 12px; /* Soft, organic rounding */
    
    /* Defaults for generic elements */
    --bg-card: #fffaf0; 
    --border: #e0e0e0; /* Subtle light border */
}

* { box-sizing: border-box; }

/* --- GLOBAL SCROLL BEHAVIOR --- */
body { 
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
    background-color: var(--bg-body); 
    color: var(--text-main); 
    margin: 0; padding: 0; height: 100vh;
    display: block; 
    overflow: auto; 
}

/* Custom Scrollbar to match Ink theme */
/* 1. Set the thickness (Vertical & Horizontal) */
::-webkit-scrollbar { 
    width: 6px;  /* Thickness of vertical scrollbar */
    height: 6px; /* Thickness of horizontal scrollbar */
}

/* 2. The Track (Background) - Always invisible */
::-webkit-scrollbar-track { 
    background: transparent; 
}

/* 3. The Thumb (Handle) - Invisible by default */
::-webkit-scrollbar-thumb { 
    background: transparent; 
    border-radius: 3px; 
}

/* 4. Reveal Logic: Show the thumb ONLY when hovering the container */
*:hover::-webkit-scrollbar-thumb { 
    /* Semi-transparent Stone Gray (Matches your palette's muted text) */
    background: rgba(158, 158, 158, 0.4); 
}

/* 5. Active Logic: Darker color when you grab/hover the scrollbar itself */
::-webkit-scrollbar-thumb:hover { 
    /* Your Primary Terracotta color */
    background: var(--primary) !important; 
}

.app-container {
    margin: 0 auto;
    min-width: 1680px; 
    min-height: 1100px; 
    height: 100vh; 
    display: flex; flex-direction: column;
    padding: 15px 25px; gap: 15px;
}

/* --- Header --- */
.app-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 5px; flex-shrink: 0; }
.header-brand { display: flex; align-items: center; gap: 12px; }
.logo-icon { font-size: 22px; color: var(--text-on-desk); }
/* Adjusted header text color to be visible on dark desk background */
.app-header h1 { font-size: 1.2rem; margin: 0; color: var(--text-on-desk); font-weight: 600; letter-spacing: -0.5px; }
.app-header h1 strong { color: var(--card-cal-accent); font-weight: 800; }

.streak-badge { display: flex; align-items: center; background: white; padding: 6px 16px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow-sm); gap: 10px; }
.streak-icon { font-size: 1.2rem; filter: grayscale(100%); opacity: 0.5; transition: all 0.3s; }
.streak-badge.active-streak .streak-icon { filter: none; opacity: 1; }
.streak-badge.target-hit .streak-icon { filter: drop-shadow(0 0 4px var(--card-perf-accent)); transform: scale(1.1); }
.streak-info { display: flex; flex-direction: column; line-height: 1; }
#streak-count { font-weight: 800; font-size: 1rem; color: var(--text-main); }
.streak-label { font-size: 0.65rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

.icon-btn { background: white; border: 1px solid var(--border); color: var(--text-muted); padding: 8px; border-radius: var(--radius); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: var(--shadow-sm); }
.icon-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

/* --- 4-COLUMN ASYMMETRICAL GRID --- */
.dashboard-grid {
    display: grid;
    grid-template-columns: 330px 1.2fr 1fr 370px; 
    grid-template-rows: 410px minmax(0, 1fr); 
    grid-template-areas: 
        "study study performance tasks"
        "leftstack timer tools log";
    gap: 20px;
    flex-grow: 1;
    min-height: 0;
}

/* --- Card General --- */
.card { 
    background: var(--bg-card); 
    border-radius: var(--radius); 
    border: 1px solid var(--border); 
    box-shadow: var(--shadow-sm); 
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
}
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0; min-height: 30px; }
.card-header.compact-header { margin-bottom: 10px; }
.card-header h3 { margin: 0; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; color: var(--text-muted); }

/* --- SPECIFIC CARD COLOR MAPPINGS --- */

/* Study: Mint */
.study-card { 
    grid-area: study; 
    background-color: var(--card-study-bg);
    border-color: rgba(26, 188, 156, 0.3);
}
.study-card .card-header h3 { color: var(--card-study-accent); }


/* Performance: Cream */
.performance-card { 
    grid-area: performance; 
    background-color: var(--card-perf-bg);
    border-color: rgba(241, 196, 15, 0.3);
}
.performance-card .card-header h3 { color: var(--card-perf-accent); }

/* Tasks: Lavender */
.tasks-card { 
    grid-area: tasks; 
    background-color: var(--card-tasks-bg);
    border-color: rgba(155, 89, 182, 0.3);
}
.tasks-card .card-header h3 { color: var(--card-tasks-accent); }

/* Left Stack: Calendar (Sky) & Score (White/Sky) */
.left-stack { 
    grid-area: leftstack; 
    display: flex; flex-direction: column; gap: 0px; 
    overflow: hidden; 
}
.calendar-card { 
    flex: 0 0 auto; padding: 12px; 
    background-color: var(--card-cal-bg);
    border-color: rgba(52, 152, 219, 0.3);
    margin-bottom: 10px;
    padding-bottom: 15px !important;
}
.calendar-card .card-header h3 { color: var(--card-cal-accent); }
.score-card { 
    flex: 0 0 250px; 
    background-color: #ffffff; /* Keep score clean white or Sky */
    border-top: 4px solid var(--card-cal-accent);
}

/* Timer: White Sketchbook */
.timer-card { 
    grid-area: timer; 
    background-color: var(--card-timer-bg);
    border: 1px solid var(--text-muted); /* Distinct sketchbook border */
    box-shadow: var(--shadow-md);
}

/* Log: Lined Paper Yellow */
.log-card { 
    grid-area: log; 
    background-color: var(--card-log-bg);
    border-color: rgba(211, 84, 0, 0.2);
}
.log-card .card-header h3 { color: var(--card-log-accent); }

/* Tools Stack: Rose */
.tools-stack { grid-area: tools; display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
.sound-card { 
    flex: 1; justify-content: center; align-items: center; position: relative; 
    background-color: var(--card-tools-bg);
    border-color: rgba(231, 76, 60, 0.2);
}
.sound-card .card-header h3 { color: var(--card-tools-accent); }


/* --- Charts --- */
.chart-wrapper { flex: 1; height: 100%; position: relative; display: flex; flex-direction: column; }
.chart-container { flex-grow: 1; width: 100%; min-height: 0; padding-left: 10px; padding-right: 10px; }
.chart-header-row { display: flex; justify-content: flex-start; align-items: center; margin-bottom: 10px; height: 36px; margin-left: 0px; }
.chart-controls-group { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    margin-bottom: 5px; /* Give it some breathing room */
}
.trend-stats-box { display: flex; align-items: center; gap: 8px; padding: 0; background: transparent; border: none; box-shadow: none; font-size: 20px; font-weight: bold; height: auto; box-sizing: border-box; opacity: 0; transition: opacity 0.3s ease; }
.trend-stats-box.visible { opacity: 0.8; }
.stat-value { color: var(--text-main); }
.stat-status { text-align: right; }

/* --- Task List --- */
#task-list { overflow-y: auto; flex-grow: 1; padding-right: 6px; min-height: 0; }
.task-item { background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; margin-bottom: 3px; display: flex; flex-direction: column; gap: 1px; transition: transform 0.1s, border-color 0.1s; }
.task-item:hover { border-color: var(--card-tasks-accent); transform: translateY(-1px); }
.task-header { display: flex; justify-content: space-between; align-items: center; }
.task-title { font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
.task-date { font-size: 0.75rem; color: var(--text-muted); }

.task-bar-bg { height: 6px; background: rgba(0,0,0,0.05); border-radius: 3px; overflow: hidden; width: 100%; margin-top: 4px; display: block; }
.task-bar-fg { height: 100%; background: var(--card-tasks-accent); width: 0%; transition: width 0.5s ease; display: block; }
.task-item.warning-urgent .task-bar-fg { background: var(--warning); }
.task-item.overdue .task-bar-fg { background: var(--danger); }
.task-item.completed { opacity: 0.6; background: rgba(255,255,255,0.5); border-style: dashed; }
.task-item.completed .task-title { text-decoration: line-through; color: var(--text-muted); }
.task-done-btn { background: white; color: var(--success); border: 1px solid var(--border); padding: 4px 8px; border-radius: 6px; font-weight: bold; cursor: pointer; line-height: 1; font-size: 0.8rem; }
.task-done-btn:hover { background: var(--success); color: white; border-color: var(--success); }

/* --- Specific Components --- */
#study-calendar .flatpickr-calendar { 
    background: transparent !important; /* No background color */
    box-shadow: none !important;        /* No shadow/border around the grid */
    border: none !important; 
    width: 100% !important; 
    margin: 0 auto !important;
    position: relative !important;
    top: 0 !important;
}

/* 2. Fix the Month & Year (Make them Accent Color, e.g., Blue) */
.flatpickr-current-month .flatpickr-monthDropdown-months,
.flatpickr-current-month input.cur-year {
    color: var(--card-cal-accent) !important; 
    font-weight: 800;
    fill: var(--card-cal-accent) !important; /* Color for the arrows */
}

/* 3. Fix the Weekdays (Sun, Mon...) */
span.flatpickr-weekday {
    color: var(--text-muted) !important; /* Muted Ink color */
    font-weight: 700;
    font-size: 0.8rem;
    text-transform: uppercase;
}

/* 4. Fix the Numbers (Make them DARK Ink) */
/* 1. Reset the cell layout */
.flatpickr-day {
    position: relative; 
    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* Align numbers to top */
    align-items: flex-start;     /* Align numbers to left */
    padding: 2px;
    height: 40px; /* Slightly taller */
    line-height: 1;
    border: 1px solid transparent; /* Prevents jumping */
}

/* 2. The Persian Date (Red Number) - Bottom Right */
.jalaali-date {
    position: absolute;
    bottom: 3px;
    right: 5px;
    font-size: 0.75rem;
    color: var(--danger); /* Red color for Persian date */
    font-weight: 700;
    opacity: 0.8;
}

/* 3. DEADLINES: Gold Dot (Top Right) */
/* This replaces the ugly yellow line */
.flatpickr-day.event-day {
    border-bottom: none !important; /* Remove the line */
}
.flatpickr-day.event-day::after {
    content: '';
    position: absolute;
    top: 5px;
    right: 30px;
    width: 6px;
    height: 6px;
    background-color: var(--warning); /* Gold */
    border-radius: 50%;
}

/* 4. STUDY DAYS: Green Dot (Top Center) or Background */
.flatpickr-day.study-day {
    background-color: rgba(102, 187, 106, 0.1); /* Very faint green background */
    font-weight: bold;
}



/* Hover Effect */
.flatpickr-day:hover {
    background: rgba(0, 0, 0, 0.05) !important; /* Slight dark hover */
    border-color: transparent !important;
}

/* Selected Day (Solid Circle) */
.flatpickr-day.selected, 
.flatpickr-day.startRange, 
.flatpickr-day.endRange {
    background: var(--card-cal-accent) !important;
    color: white !important; /* Keep text white only when background is blue */
    border-color: var(--card-cal-accent) !important;
    font-weight: 700;
}

/* Today (Outlined) */
.flatpickr-day.today {
    border: 2px solid var(--card-cal-accent) !important;
    color: var(--card-cal-accent) !important;
}
.flatpickr-day.today:hover {
    background: var(--card-cal-accent) !important;
    color: white !important;
}
.score-grid { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
#scoreInput { width: 80px; text-align: center; font-weight: 700; color: var(--primary); }

/* --- TIMER --- */
.timer-card { position: relative; box-shadow: var(--shadow-md); border-color: var(--border); }
.timer-mode-switcher { display: flex; background: var(--bg-body); padding: 4px; border-radius: calc(var(--radius) + 4px); margin: 0 auto 15px auto; width: fit-content; border: 1px solid var(--border); }
.mode-tab { background: transparent; border: none; padding: 8px 24px; font-size: 0.85rem; font-weight: 600; color: #ecf0f1; border-radius: var(--radius); cursor: pointer; transition: all 0.2s; position: relative; }
.mode-tab.active { background: white; color: var(--text-main); box-shadow: var(--shadow-sm); }
.mode-tab.running { color: var(--success); border-bottom: 2px solid var(--success); border-radius: 4px; }
.mode-tab.running::after { content: ''; position: absolute; top: 6px; right: 6px; width: 6px; height: 6px; background-color: var(--success); border-radius: 50%; box-shadow: 0 0 4px var(--success); }

.timer-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
.timer-panel { display: flex; flex-direction: column; height: 100%; gap: 15px; justify-content: center; align-items: center; }
.timer-panel .input-group, .timer-panel .modern-select, .timer-panel .modern-textarea { width: 100%; max-width: 400px; text-align: center; }
.timer-panel .modern-select { text-align-last: center; }
.timer-display-container { text-align: center; margin: 5px 0; }
.main-timer-text { font-size: 4rem; font-weight: 700; font-variant-numeric: tabular-nums; color: var(--text-main); line-height: 1; letter-spacing: -2px; }
.status-badge { display: inline-block; margin-top: 8px; padding: 6px 16px; border-radius: 20px; background: var(--primary-light); color: var(--primary); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
.status-badge:empty { display: none; }
.status-badge.break-mode { background-color: var(--success-bg); color: var(--success); }
.countdown-inputs-row { display: flex; justify-content: center; gap: 12px; margin-bottom: 10px; }
.time-input-wrapper { display: flex; flex-direction: column; align-items: center; }
.time-input-wrapper input { width: 55px; height: 45px; text-align: center; font-size: 1.3rem; padding: 0; border: none; background: #f8f9fa; border-radius: 10px; color: var(--text-main); font-weight: 700; transition: all 0.2s; border: 1px solid var(--border); }
.time-input-wrapper input:focus { outline: 2px solid var(--primary); background: white; transform: translateY(-2px); }
.time-input-wrapper label { font-size: 0.6rem; color: var(--text-muted); margin-top: 4px; font-weight: 700; letter-spacing: 1px; }
.timer-actions { display: flex; justify-content: center; gap: 16px; }

/* --- TOOLS STACK (Sound & Breath) --- */
.sound-controls { display: flex; flex-direction: column; align-items: center; gap: 15px; width: 100%; margin-top: 10px; }
.sound-btn-row { display: flex; gap: 12px; }

.sound-btn { width: 50px; height: 50px; border-radius: 50%; border: 1px solid var(--border); background: white; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: center; }
.sound-btn:hover { transform: translateY(-2px); border-color: var(--card-tools-accent); color: var(--card-tools-accent); box-shadow: var(--shadow-sm); }
.sound-btn.active { background: var(--card-tools-accent); color: white; border-color: var(--card-tools-accent); box-shadow: 0 0 15px rgba(231, 76, 60, 0.4); animation: pulse-soft 2s infinite; }

.sound-stop-btn { width: 50px; height: 50px; border-radius: 50%; border: 1px solid var(--danger-bg); background: var(--card-tools-bg); color: var(--danger); font-size: 1.2rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.sound-stop-btn:hover { background: var(--danger); color: white; border-color: var(--danger); transform: translateY(-2px); }

.volume-slider-container { width: 80%; display: flex; align-items: center; gap: 10px; color: var(--text-muted); }
.volume-slider { flex-grow: 1; -webkit-appearance: none; appearance: none; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; outline: none; }
.volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: var(--card-tools-accent); cursor: pointer; transition: transform 0.1s; }
.volume-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }

/* Breathing Card Container - Adapted for "Rose" theme */
.breathing-card {
    order: -1;
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    background: radial-gradient(circle at center, #fff 0%, var(--card-tools-bg) 100%);
    overflow: hidden;
    border-radius: var(--radius);
    border: 1px solid var(--border);
}

/* The Clickable Trigger Area */
.breathing-circle-container {
    position: relative;
    width: 140px;
    height: 140px;
    margin-top: 15px;
    cursor: pointer;
    z-index: 10;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* --- ORB LAYERS --- */
.orb-layer {
    position: absolute;
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: none;
    will-change: transform; 
}

/* 1. The Center Core */
.orb-core {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--card-tools-accent), #e67e22);
    box-shadow: 0 0 30px rgba(231, 76, 60, 0.4);
    z-index: 5;
    transition: opacity 0.5s ease;
}

/* 2. The Outer Glow */
.orb-glow {
    width: 120px;
    height: 120px;
    background: radial-gradient(circle, rgba(231, 76, 60, 0.2) 0%, rgba(255,255,255,0) 70%);
    z-index: 1;
    opacity: 0.5;
}

/* 3. The Orbiting Ring */
.orb-ring {
    width: 110px;
    height: 110px;
    border: 1px solid rgba(231, 76, 60, 0.2);
    z-index: 2;
}

/* The Satellite Dot */
.orb-ring::after {
    content: '';
    position: absolute;
    top: -4px;
    left: 50%;
    transform: translateX(-50%);
    width: 8px;
    height: 8px;
    background-color: var(--card-tools-accent);
    border-radius: 50%;
    box-shadow: 0 0 10px var(--card-tools-accent);
}

.lotus-petal {
    position: absolute;
    width: 26px;
    height: 45px; 
    /* Rose/Red Petals for the tool theme */
    background: linear-gradient(to top, rgba(231, 76, 60, 0.85) 0%, rgba(253, 237, 236, 0.3) 100%);
    border-radius: 50% 50% 50% 50% / 70% 70% 30% 30%;
    left: 50%;
    bottom: 50%;
    margin-left: -13px; 
    transform-origin: bottom center;
    transform: rotate(var(--r)) scale(1);
    mix-blend-mode: normal; 
    box-shadow: 0 -2px 5px rgba(192, 57, 43, 0.15); 
    opacity: 0; 
    transition: opacity 0.5s, transform 0.5s ease;
    will-change: transform;
}

/* Style Active State */
.style-lotus .orb-core { 
    opacity: 1; 
    width: 12px; 
    height: 12px; 
    background: #f1c40f; 
    box-shadow: 0 0 10px rgba(241, 196, 15, 0.6);
    z-index: 20; 
}
.style-lotus .orb-ring, .style-lotus .orb-glow { opacity: 0; } 
.style-lotus .lotus-petal { opacity: 1; }


/* --- OPTIMIZED ANIMATIONS --- */

/* 1. Core Pulsing (Normal Mode) */
@keyframes breathe-orb-core-smooth {
    0%   { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
    25%  { transform: translate(-50%, -50%) scale(1.8); opacity: 1; box-shadow: 0 0 60px rgba(231, 76, 60, 0.6); } 
    /* FIX: Stay at scale 1.8 during the HOLD phase (25% to 50%) */
    50%  { transform: translate(-50%, -50%) scale(1.8); opacity: 1; } 
    75%  { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
    /* FIX: Stay at scale 1 during the HOLD EMPTY phase (75% to 100%) */
    100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
}


/* 2. Ring Spinning */
@keyframes spin-ring-smooth {
    0%   { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
    12.5% { transform: translate(-50%, -50%) rotate(45deg) scale(1.15); } 
    25%  { transform: translate(-50%, -50%) rotate(90deg) scale(1.3); } 
    50%  { transform: translate(-50%, -50%) rotate(180deg) scale(1.3); } 
    62.5% { transform: translate(-50%, -50%) rotate(225deg) scale(1.15); } 
    75%  { transform: translate(-50%, -50%) rotate(270deg) scale(1); } 
    100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); } 
}

/* 2. Lotus Blooming */
@keyframes breathe-lotus-smooth {
    0%   { transform: rotate(var(--r)) scale(1); }
    25%  { transform: rotate(var(--r)) scale(1.6) translateY(-8px); } 
    /* FIX: Stay exactly matching the 25% state */
    50%  { transform: rotate(var(--r)) scale(1.6) translateY(-8px); } 
    75%  { transform: rotate(var(--r)) scale(1); } 
    100% { transform: rotate(var(--r)) scale(1); }
}

/* Apply Animations */
.breathing-active .orb-core { animation: breathe-orb-core-smooth 16s infinite ease-in-out; }
.breathing-active .orb-ring { animation: spin-ring-smooth 16s infinite linear; }
.breathing-active .lotus-petal { animation: breathe-lotus-smooth 16s infinite ease-in-out; }


/* --- TEXT & FOOTER --- */
.breathing-text {
    margin-top: 40px; 
    font-weight: 700;
    color: var(--card-tools-accent);
    font-size: 0.9rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    min-height: 1.2em;
    transition: all 0.5s;
    opacity: 0.8;
}

.breathing-footer {
    position: absolute;
    bottom: 10px;
    width: 100%;
    display: flex;
    justify-content: center;
}

.style-toggle-btn {
    background: none;
    border: 1px solid transparent;
    font-size: 0.7rem;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s;
    z-index: 20;
}
.style-toggle-btn:hover { background: rgba(0,0,0,0.05); color: var(--card-tools-accent); }

/* --- ZEN MODE --- */
body.breathing-mode .breathing-text {
    font-size: 2rem;
    margin-top: 100px;
    color: var(--card-tools-accent);
    text-shadow: 0 2px 10px rgba(231, 76, 60, 0.2);
}

body.breathing-mode .breathing-circle-container { width: 300px; height: 300px; }

body.breathing-mode .orb-core { width: 100px; height: 100px; }
body.breathing-mode .orb-glow { width: 300px; height: 300px; }
body.breathing-mode .orb-ring { width: 220px; height: 220px; }
body.breathing-mode .lotus-petal {
    width: 70px; 
    height: 140px; 
    margin-left: -35px; 
    box-shadow: none;
    background: linear-gradient(to top, rgba(231, 76, 60, 0.9) 0%, rgba(253, 237, 236, 0.4) 100%);
}

body.breathing-mode.breathing-active .orb-core { animation-name: breathe-orb-core-zen-smooth; }

/* 3. Zen Mode Pulsing */
@keyframes breathe-orb-core-zen-smooth {
    0%   { transform: translate(-50%, -50%) scale(1); }
    25%  { transform: translate(-50%, -50%) scale(2.0); box-shadow: 0 0 100px rgba(231, 76, 60, 0.8); }
    /* FIX: Stay at scale 2.0 */
    50%  { transform: translate(-50%, -50%) scale(2.0); }
    75%  { transform: translate(-50%, -50%) scale(1); }
    100% { transform: translate(-50%, -50%) scale(1); }
}

@keyframes breathe-anim {
    0%   { transform: scale(0.8); }  
    25%  { transform: scale(1.5); }  
    50%  { transform: scale(1.5); }  
    75%  { transform: scale(0.8); }  
    100% { transform: scale(0.8); }  
}
.breathing-active .breathing-circle-outer { animation: breathe-anim 16s infinite ease-in-out; }
@keyframes pulse-soft { 
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 
    70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } 
}

/* --- LOG --- */
#sessionLog { flex-grow: 1; overflow-y: auto; padding-right: 4px; min-height: 0; }
.log-item, .score-item { padding: 14px 0; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 1fr auto; grid-template-rows: auto auto; gap: 4px 12px; }
.log-item:last-child { border-bottom: none; }
.log-course { font-weight: 700; font-size: 1rem; color: var(--text-main); grid-column: 1; }
.log-meta { grid-column: 2; display: flex; align-items: center; gap: 4px; justify-content: flex-end; }
.log-date { font-size: 0.85rem; color: var(--text-muted); font-variant-numeric: tabular-nums; }
.log-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
.log-item:hover .log-actions, .score-item:hover .log-actions { opacity: 1; }
.log-notes { grid-column: 1 / -1; font-size: 0.9rem; color: var(--text-muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.score-value { color: var(--success); font-weight: 800; font-size: 1rem; }

.modern-select, .modern-input, .modern-textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius); font-family: inherit; font-size: 0.9rem; color: var(--text-main); background: #ffffff; transition: all 0.2s; }
.modern-select:focus, .modern-input:focus, .modern-textarea:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1); }
.large-text { font-size: 1.1rem; padding: 10px; font-weight: 500; text-align: center; }
.modern-textarea { resize: vertical; min-height: 60px; width: 100%; box-sizing: border-box; }

.chart-controls-group { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    margin-bottom: 5px; /* Give it some breathing room */
}

/* 2. The Select Box Itself */
.trend-select {
    /* Remove default ugly browser styling */
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;

    /* Pill Shape & Sizing */
    background-color: white;
    border-radius: 20px; /* Full organic rounding */
    padding: 6px 34px 6px 14px; /* Extra right padding for the arrow */
    
    /* Typography */
    font-family: inherit;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--text-muted); /* Stone Gray text */
    
    /* Border - Subtle Stone */
    border: 1px solid var(--border);
    cursor: pointer;
    
    /* Transitions for interaction */
    transition: all 0.2s ease;
    box-shadow: var(--shadow-sm);

    /* 3. THE CUSTOM ARROW (Encoded SVG) */
    /* This creates a small chevron arrow matching your theme */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%239e9e9e' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
}

/* 4. Hover State - Terracotta Highlight */
.trend-select:hover {
    color: var(--primary);       /* Turn text Terracotta */
    border-color: var(--primary); /* Turn border Terracotta */
    background-color: var(--card-perf-bg); /* Slight Adobe Gold tint */
    
    /* Change arrow color on hover (New SVG with Terracotta color) */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%238b3a3a' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
    
    transform: translateY(-1px); /* Subtle lift */
    box-shadow: var(--shadow-md);
}

/* 5. Focus State (When clicked) */
.trend-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(139, 58, 58, 0.1); /* Soft Terracotta Glow */
}

.btn { border: 1px solid transparent; padding: 10px 18px; border-radius: var(--radius); font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; }
.btn:active { transform: translateY(1px); }
.btn-primary { background-color: var(--primary); color: white; box-shadow: 0 2px 4px rgba(44, 62, 80, 0.2); }
.btn-primary:hover { background-color: var(--primary-hover); box-shadow: 0 4px 8px rgba(44, 62, 80, 0.3); }
.btn-danger { background-color: var(--card-tools-bg); color: var(--danger); border: 1px solid var(--danger); }
.btn-danger:hover { background-color: var(--danger); color: white; }
.btn-ghost { background: transparent; color: var(--text-muted); }
.btn-ghost:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }
.btn-outline { background: transparent; border-color: var(--border); color: var(--text-main); }
.btn-outline:hover { border-color: var(--text-muted); background: white; }
.btn-large { padding: 14px 40px; font-size: 1.1rem; }

/* 1. The Background Bar (The Dock) */
.toggle-pill-container { 
    display: inline-flex; 
    align-items: center;
    justify-content: center;
    gap: 4px; /* Tiny gap between pills */
    
    /* Create a subtle, sunken stone look */
    background: rgba(74, 65, 58, 0.06); 
    border: 1px solid rgba(0,0,0,0.05);
    
    padding: 4px; 
    border-radius: 20px; /* Fully rounded ends */
    margin: 0 auto; /* Center it if possible */
}

/* 2. The Individual Buttons (The Pills) */
.toggle-pill { 
    /* FIX: layout & Sizing */
    width: 70px;        /* Fixed width stops horizontal jumping */
    height: 28px;       /* Fixed height ensures vertical consistency */
    padding: 0;         /* Remove padding, let Flexbox handle alignment */
    
    /* FIX: Perfect Centering */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    
    /* Reset styles */
    background: transparent; 
    border: none; 
    border-radius: 14px; /* Half of height for perfect roundness */
    
    /* Typography */
    font-size: 0.75rem; 
    font-weight: 600; 
    color: var(--text-muted); 
    text-transform: uppercase;
    letter-spacing: 0.5px;
    
    cursor: pointer; 
    transition: all 0.2s ease;
}

/* 3. Hover State */
.toggle-pill:hover { 
    color: var(--text-main); 
    background: rgba(255, 255, 255, 0.4); 
}

/* 4. Active State */
.toggle-pill.active { 
    background: white; 
    color: var(--primary); 
    
    /* Shadow for lift */
    box-shadow: 0 2px 5px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.1);
    
    /* Safe to bold now because width is fixed at 70px */
    font-weight: 800; 
}

/* 3. Hover State (Soft highlight) */
.toggle-pill:hover { 
    color: var(--text-main); 
    background: rgba(255, 255, 255, 0.4); 
}

#trendSpanSelect {
    margin-left: 8px;
    border-radius: 16px;
    border: 1px solid var(--border);
    padding: 4px 8px;
    font-size: 0.75rem;
    color: var(--text-muted);
    background: transparent;
    cursor: pointer;
}
#trendSpanSelect:hover {
    border-color: var(--primary);
    color: var(--primary);
}
.text-link-btn { background: none; border: none; color: var(--primary); font-size: 0.8rem; font-weight: 600; cursor: pointer; }
.text-link-btn:hover { text-decoration: underline; }

.action-icon-btn { background: transparent; border: none; cursor: pointer; padding: 4px; border-radius: 4px; color: var(--text-muted); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.action-icon-btn svg { width: 14px; height: 14px; stroke-width: 2.5; }
.action-icon-btn.edit:hover { color: var(--primary); background: rgba(52, 73, 94, 0.1); }
.action-icon-btn.delete:hover { color: var(--danger); background: var(--danger-bg); }

.tippy-box { background-color: var(--primary); color: white; border-radius: var(--radius); font-family: 'Inter', sans-serif; font-size: 0.75rem; font-weight: 500; padding: 4px 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 9999 !important; }
.tippy-arrow { color: var(--primary); }

.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.8); backdrop-filter: blur(2px); z-index: 20000; align-items: center; justify-content: center; }
.modal-content { background: white; border-radius: var(--radius); box-shadow: var(--shadow-lg); padding: 24px; width: 450px; max-width: 90%; }
.modal-content h2 { margin-top: 0; color: var(--text-main); font-size: 1.2rem; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.modal-footer { margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px; }
.chart-modal-content { width: 85%; height: 85vh; display: flex; flex-direction: column; }
#zoomed-chart-container { flex-grow: 1; width: 100%; height: 100%; pointer-events: auto; }

.hidden { display: none !important; }
.error-message { color: var(--danger); font-size: 0.8rem; margin-top: 4px; }

/* --- ZEN MODE (Timer Focus) --- */
body.focus-mode .app-header, body.focus-mode .left-stack, body.focus-mode .tasks-card, body.focus-mode .log-card, body.focus-mode .study-card, body.focus-mode .performance-card, body.focus-mode .tools-stack { display: none; }
body.focus-mode .dashboard-grid { display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh; margin: 0; padding: 0; }
body.focus-mode .timer-card { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; max-width: none; max-height: none; margin: 0; padding: 0; border: none; border-radius: 0; box-shadow: none; background: var(--bg-body); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
body.focus-mode .card-header h3 { display: none; }
body.focus-mode .card-header { position: absolute; top: 20px; right: 20px; width: auto; margin: 0; }
body.focus-mode .timer-body { width: 100%; max-width: 600px; }
/* --- FIX: Make text visible against dark background --- */
body.focus-mode .main-timer-text { 
    color: var(--text-on-desk); 
}

body.focus-mode .time-input-wrapper label {
    color: var(--text-on-desk);
}

body.focus-mode .mode-tab {
    color: var(--text-muted); 
}
body.focus-mode .mode-tab.active {
    color: var(--text-main); /* Keep active tab dark text on white bg */
}
body.focus-mode #btn-focus-mode { background: rgba(231, 76, 60, 0.2); color: #c0392b; border: 1px solid rgba(231, 76, 60, 0.3); padding: 8px 16px; width: auto; border-radius: 8px; font-weight: 600; display: flex; gap: 8px; }

/* --- BREATHING ZEN MODE --- */
body.breathing-mode .app-header, 
body.breathing-mode .left-stack, 
body.breathing-mode .tasks-card, 
body.breathing-mode .log-card, 
body.breathing-mode .study-card, 
body.breathing-mode .performance-card, 
body.breathing-mode .timer-card,
body.breathing-mode .sound-card { 
    display: none !important; 
}

body.breathing-mode .dashboard-grid {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100vw;
    height: 100vh;
    margin: 0;
    padding: 0;
}

body.breathing-mode .tools-stack {
    width: 100%;
    height: 100%;
    overflow: visible;
}

body.breathing-mode .breathing-card {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 20000;
    border-radius: 0;
    border: none;
    box-shadow: none;
    /* Full screen Rose gradient for breathing mode */
    background: radial-gradient(circle at center, #fff 0%, var(--card-tools-bg) 100%);
}

body.breathing-mode .card-header { display: none; }

body.breathing-mode .breathing-circle-container {
    width: 300px;
    height: 300px;
    margin-top: 0;
}

body.breathing-mode .breathing-text {
    font-size: 2.5rem;
    margin-top: 80px;
    color: var(--card-tools-accent);
}

.pie-center-text {
    position: absolute;
    
    /* SYNC X: Must match ECharts center[0] exactly */
    left: 42%; 
    
    /* SYNC Y: Must match ECharts center[1] exactly */
    top: 50%;
    
    /* Center the div itself on that point */
    transform: translate(-50%, -50%); 
    
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    pointer-events: none; 
    z-index: 10;
}

.pie-val-text {
    font-size: 2.8rem;
    font-weight: 800;
    color: var(--text-main);
    line-height: 1;
}

.pie-label-text {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--card-log-accent); 
    letter-spacing: 2px;
    margin-top: 4px;
}

.pie-center-text.hidden { display: none; }
</file>

</files>
